<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">

<!-- Mirrored from wiki.sigmah.org/doku.php?id=contributorguide:schemachangelog by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Jul 2018 16:39:08 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <title>contributorguide:schemachangelog [Sigmah wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="contributorguide,schemachangelog"/>
<link rel="search" type="application/opensearchdescription+xml" href="lib/exe/opensearch.php" title="Sigmah wiki"/>
<link rel="start" href="index.html"/>
<link rel="contents" href="doku113d.html?id=contributorguide:schemachangelog&amp;do=index" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="feed3c04.php?mode=list&amp;ns=contributorguide"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="doku311e.html?do=export_xhtml&amp;id=contributorguide:schemachangelog"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="schemachangelogff11.txt?do=export_raw&amp;id=contributorguide:schemachangelog"/>
<link rel="canonical" href="doku17a0.html?id=contributorguide:schemachangelog"/>
<link rel="stylesheet" type="text/css" href="lib/exe/cssaf43.css?t=dokuwiki&amp;tseed=74cd2fc0434d10331b9bc01ea3827dea"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='contributorguide';var JSINFO = {"id":"contributorguide:schemachangelog","namespace":"contributorguide"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="lib/exe/jquery1d4f.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="lib/exe/jsaf43.php?t=dokuwiki&amp;tseed=74cd2fc0434d10331b9bc01ea3827dea"></script>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="lib/tpl/dokuwiki/images/favicon.ico" />
<link rel="apple-touch-icon" href="lib/tpl/dokuwiki/images/apple-touch-icon.png" />
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki    showSidebar hasSidebar">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="doku81aa.html?id=start"  accesskey="h" title="[H]"><img src="lib/tpl/dokuwiki/images/logo.png" width="64" height="64" alt="" /> <span>Sigmah wiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="dokuead7.html?id=contributorguide:schemachangelog&amp;do=register"  class="action register" rel="nofollow" title="Register">Register</a></li><li><a href="doku6214.html?id=contributorguide:schemachangelog&amp;do=login&amp;sectok="  class="action login" rel="nofollow" title="Log In">Log In</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="http://wiki.sigmah.org/doku.php?id=start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" placeholder="Search" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><button type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="http://wiki.sigmah.org/doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="contributorguide:schemachangelog" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent Changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Log In</option><option value="register">Register</option></optgroup></select><button type="submit">&gt;</button></div></form>            </div>
            <ul>
                <li><a href="dokub686.html?id=contributorguide:schemachangelog&amp;do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Recent Changes [R]">Recent Changes</a></li><li><a href="doku7a57.html?id=contributorguide:schemachangelog&amp;do=media&amp;ns=contributorguide"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="doku113d.html?id=contributorguide:schemachangelog&amp;do=index"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                                        <div class="trace"><span class="bchead">Trace:</span> <span class="bcsep">•</span> <bdi><a href="doku81aa.html?id=start"  class="breadcrumbs" title="start">start</a></bdi> <span class="bcsep">•</span> <bdi><a href="dokuebef.html?id=administratorguide:administratorguide"  class="breadcrumbs" title="administratorguide:administratorguide">administratorguide</a></bdi> <span class="bcsep">•</span> <bdi><a href="doku4692.html?id=contributorguide:contributorguide"  class="breadcrumbs" title="contributorguide:contributorguide">contributorguide</a></bdi> <span class="bcsep">•</span> <bdi><a href="dokuc3da.html?id=model:sidebar"  class="breadcrumbs" title="model:sidebar">sidebar</a></bdi> <span class="bcsep">•</span> <bdi><a href="dokubf2f.html?id=translationguide"  class="breadcrumbs" title="translationguide">translationguide</a></bdi> <span class="bcsep">•</span> <bdi><a href="doku0050.html?id=ssoc:ssocintroduction"  class="breadcrumbs" title="ssoc:ssocintroduction">ssocintroduction</a></bdi> <span class="bcsep">•</span> <bdi><a href="doku98ce.html?id=optimisation:conception"  class="breadcrumbs" title="optimisation:conception">conception</a></bdi> <span class="bcsep">•</span> <bdi><a href="doku1ba3.html?id=administratorguide:installingsigmah"  class="breadcrumbs" title="administratorguide:installingsigmah">installingsigmah</a></bdi> <span class="bcsep">•</span> <span class="curid"><bdi><a href="doku17a0.html?id=contributorguide:schemachangelog"  class="breadcrumbs" title="contributorguide:schemachangelog">schemachangelog</a></bdi></span></div>
                    </div>
    


    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

                            <!-- ********** ASIDE ********** -->
                <div id="dokuwiki__aside"><div class="pad aside include group">
                    <h3 class="toggle">Sidebar</h3>
                    <div class="content"><div class="group">
                                                                        <ul>
<li class="level1 node"><div class="li"> <a href="doku4692.html?id=contributorguide:contributorguide" class="wikilink1" title="contributorguide:contributorguide">Overview</a></div>
<ul>
<li class="level2"><div class="li"> Organizations involved and roles</div>
</li>
<li class="level2"><div class="li"> <a href="dokub5e4.html?id=contributorguide:projectcommunitycommunication" class="wikilink1" title="contributorguide:projectcommunitycommunication">Communication tools for the contributors</a></div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <a href="doku032a.html?id=contributorguide:contributionrules" class="wikilink1" title="contributorguide:contributionrules">Contribution rules</a></div>
<ul>
<li class="level2"><div class="li"> <a href="doku8376.html?id=contributorguide:versioncycle" class="wikilink1" title="contributorguide:versioncycle">Versions cycle</a></div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <a href="dokua44f.html?id=contributorguide:building" class="wikilink1" title="contributorguide:building">Build up environment</a></div>
<ol>
<li class="level2"><div class="li"> <a href="dokub007.html?id=contributorguide:preparebuildenvironment" class="wikilink1" title="contributorguide:preparebuildenvironment">Prepare your build environment</a></div>
</li>
<li class="level2"><div class="li"> <a href="dokue387.html?id=contributorguide:preparerunningenvironment" class="wikilink1" title="contributorguide:preparerunningenvironment">Prepare your running environment</a></div>
</li>
<li class="level2 node"><div class="li"> <a href="dokud070.html?id=contributorguide:setupide" class="wikilink1" title="contributorguide:setupide">Set up your IDE</a></div>
<ul>
<li class="level3"><div class="li"> <span class="curid"><a href="doku6318.html?id=contributorguide:netbeans" class="wikilink1" title="contributorguide:netbeans">Netbeans</a></span></div>
</li>
<li class="level3"><div class="li"> <a href="doku0994.html?id=contributorguide:eclipse" class="wikilink1" title="contributorguide:eclipse">Eclipse</a></div>
</li>
<li class="level3"><div class="li"> <a href="doku7c37.html?id=contributorguide:intellijidea" class="wikilink1" title="contributorguide:intellijidea">Intellij IDEA</a></div>
</li>
</ul>
</li>
</ol>
</li>
<li class="level1 node"><div class="li"> Understanding the code base</div>
<ul>
<li class="level2"><div class="li"> Application architecture</div>
</li>
<li class="level2"><div class="li"> Domain objects</div>
</li>
<li class="level2"><div class="li"> Other design topics</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <a href="doku620b.html?id=contributorguide:mockups" class="wikilink1" title="contributorguide:mockups">Mockups guidelines</a></div>
</li>
<li class="level1"><div class="li"> <a href="dokuc325.html?id=contributorguide:performanceoptimisation" class="wikilink1" title="contributorguide:performanceoptimisation">Performance optimisation</a></div>
</li>
<li class="level1"><div class="li"> <a href="dokucabe.html?id=contributorguide:troubleshooting" class="wikilink1" title="contributorguide:troubleshooting">Troubleshooting</a></div>
</li>
<li class="level1"><div class="li"> <a href="dokue0b6.html?id=contributorguide:buildspecialversion" class="wikilink1" title="contributorguide:buildspecialversion">Build custom Sigmah version for my NGO</a></div>
</li>
<li class="level1"><div class="li"> <a href="doku0d9f.html?id=contributorguide:codekeeperguide" class="wikilink1" title="contributorguide:codekeeperguide">Code keeper guide</a></div>
</li>
<li class="level1"><div class="li"> <a href="doku17a0.html?id=contributorguide:schemachangelog" class="wikilink1" title="contributorguide:schemachangelog">Schema changelog</a></div>
</li>
</ul>
                                            </div></div>
                </div></div><!-- /aside -->
            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>contributorguide:schemachangelog</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#introduction">Introduction</a></div></li>
<li class="level1"><div class="li"><a href="#release_23">Release 2.3</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes">1. Schema changes</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_22">Release 2.2</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes1">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_21">Release 2.1</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes2">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates1">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_20">Release 2.0</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes3">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates2">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_12">Release 1.2</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes4">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates3">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_11">Release 1.1</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes5">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates4">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_10-rc2">Release 1.0-rc2</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes6">1. Schema changes</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_10">Release 1.0</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes7">1. Schema changes</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_091">Release 0.9.1</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#schema_changes8">1. Schema changes</a></div></li>
<li class="level2"><div class="li"><a href="#existing_data_updates5">2. Existing data updates</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#release_09">Release 0.9</a></div></li>
<li class="level1"><div class="li"><a href="#revision_r1215_httpscodegooglecom_p_sigma-h_source_detail_r_1215">Revision [r1215](https://code.google.com/p/sigma-h/source/detail?r=1215)</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="introduction">Introduction</h1>
<div class="level1">

<p>
Every attempt will be made to keep new versions of Sigmah backwards compatible with SQL databases created with earlier versions of Sigmah, but sometimes there will be a need for breaking changes. These can be found here.
</p>

<p>
All SQL commands below should be able to be runned on PostgreSQL database. Ideally, they should be written respecting the ANSI SQL norm.
</p>

</div>

<h1 class="sectionedit2" id="release_23">Release 2.3</h1>
<div class="level1">

</div>

<h2 class="sectionedit3" id="schema_changes">1. Schema changes</h2>
<div class="level2">
<dl class="code">
<dt><a href="sigmah-schemachanges-v2.30869.sql?do=export_code&amp;id=contributorguide:schemachangelog&amp;codeblock=0" title="Download Snippet" class="mediafile mf_sql">sigmah-schemachanges-v2.3.sql</a></dt>
<dd><pre class="code postgresql"><span class="co1">-- Iteration &quot;type&quot; for more intuitive iteration group manipulation (#928)</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> layout_group <span class="kw1">ADD</span> <span class="kw1">COLUMN</span> iteration_type <span class="kw5">character varying</span> <span class="br0">&#40;</span><span class="nu0">8192</span><span class="br0">&#41;</span>;
&nbsp;
<span class="co1">-- Limit contacts available for a contact list according to a contact model checkbox field (#1018)</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> contact_list_element
    <span class="kw1">ADD</span> <span class="kw1">COLUMN</span> id_checkbox_element <span class="kw5">bigint</span>;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> contact_list_element
    <span class="kw1">ADD</span> <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_checkbox_element<span class="br0">&#41;</span>
    <span class="kw1">REFERENCES</span> checkbox_element <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
    <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
    <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>;
&nbsp;
<span class="co1">-- Importation frameworks for Contact models (#924)</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> importation_scheme_model <span class="kw1">ADD</span> id_contact_model <span class="kw5">integer</span>;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> importation_scheme_model <span class="kw1">ADD</span> <span class="kw1">CONSTRAINT</span> importation_scheme_model_id_contact_model_fkey
  <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span> <span class="kw1">REFERENCES</span> contact_model<span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>;</pre>
</dd></dl>

</div>

<h1 class="sectionedit4" id="release_22">Release 2.2</h1>
<div class="level1">

</div>

<h2 class="sectionedit5" id="schema_changes1">1. Schema changes</h2>
<div class="level2">
<dl class="code">
<dt><a href="sigmah-schemachanges-v2.21f77.sql?do=export_code&amp;id=contributorguide:schemachangelog&amp;codeblock=1" title="Download Snippet" class="mediafile mf_sql">sigmah-schemachanges-v2.2.sql</a></dt>
<dd><pre class="code postgresql"><span class="co1">-- Project team sub-tab (#620) </span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> project_team_members
<span class="br0">&#40;</span>
  id_project <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  userid <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> fk_70qe4sufg4oab00hik1d550jq <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_project<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> project <span class="br0">&#40;</span>databaseid<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> fk_npm2g3bmepw61ye0vvce18614 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>userid<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> userlogin <span class="br0">&#40;</span>userid<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> uk_aiug08fx4cx6p93ynvqlgp7xu <span class="kw1">UNIQUE</span> <span class="br0">&#40;</span>id_project, userid<span class="br0">&#41;</span>
<span class="br0">&#41;</span>
<span class="kw1">WITH</span> <span class="br0">&#40;</span>
  <span class="kw1">OIDS</span><span class="sy0">=</span><span class="kw1">FALSE</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> project_team_member_profiles
<span class="br0">&#40;</span>
  id_project <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_profile <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> fk_9jyuxw6qomv6jou6tt5ogs4yq <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_project<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> project <span class="br0">&#40;</span>databaseid<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> fk_ho3qygde3ttb969mpa5k1wn7k <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_profile<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> profile <span class="br0">&#40;</span>id_profile<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> uk_asrruyupsb7jmfcgbrr9i8vn4 <span class="kw1">UNIQUE</span> <span class="br0">&#40;</span>id_project, id_profile<span class="br0">&#41;</span>
<span class="br0">&#41;</span>
<span class="kw1">WITH</span> <span class="br0">&#40;</span>
  <span class="kw1">OIDS</span><span class="sy0">=</span><span class="kw1">FALSE</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- User attached to several OrgUnit (#243)</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> user_unit <span class="kw1">ADD</span> <span class="kw1">COLUMN</span> user_unit_type varchar<span class="br0">&#40;</span><span class="nu0">32</span><span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- Data framework feature foundations development (#860)</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> framework
<span class="br0">&#40;</span>
  id_framework <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  availability_status <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  implementation_status <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  label <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_organization <span class="kw5">integer</span>,
  <span class="kw1">CONSTRAINT</span> framework_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_3l3o8bnug9ymilr8irjecxfxy <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> organization <span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> framework_fulfillment
<span class="br0">&#40;</span>
  id_framework_fulfillment <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  reject_reason <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>,
  id_framework <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_project_model <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> framework_fulfillment_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_fulfillment<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_hn13s8iybgi1vdo47xkqqd0b7 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework <span class="br0">&#40;</span>id_framework<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> fk_rs0vcqcllktrd5d12o1blowqe <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_project_model<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> project_model <span class="br0">&#40;</span>id_project_model<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> uk_rs0vcqcllktrd5d12o1blowqe <span class="kw1">UNIQUE</span> <span class="br0">&#40;</span>id_project_model, id_framework<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> framework_hierarchy
<span class="br0">&#40;</span>
  id_framework_hierarchy <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  label <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">level</span> <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_framework <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  parent_hierarchy <span class="kw5">integer</span>, <span class="co1">-- XXX: Useless if the hierarchy is not a tree</span>
  <span class="kw1">CONSTRAINT</span> framework_hierarchy_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_hierarchy<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_6ap8cn4cxh5vj7163tyvlk03b <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>parent_hierarchy<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework_hierarchy <span class="br0">&#40;</span>id_framework_hierarchy<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> fk_g7s48h8iyf2po13qyi6sd5qtb <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework <span class="br0">&#40;</span>id_framework<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> framework_hierarchy_level_check <span class="kw1">CHECK</span> <span class="br0">&#40;</span><span class="kw1">level</span> <span class="sy0">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> framework_element
<span class="br0">&#40;</span>
  id_framework_element <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  data_type <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  label <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  value_rule <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_framework_hierarchy <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> framework_element_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_element<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_j2vqfnb56b43qyrxp0cuoyd60 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_hierarchy<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework_hierarchy <span class="br0">&#40;</span>id_framework_hierarchy<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> framework_element_implementation
<span class="br0">&#40;</span>
  id_framework_element_implementation <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_flexible_element <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_framework_element <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_framework_fulfillment <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> framework_element_implementation_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_element_implementation<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_1q2w7ryycg4e220id3s69kdgu <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_element<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework_element <span class="br0">&#40;</span>id_framework_element<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> fk_haj6o47cyolg7xjob4uymvndw <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> flexible_element <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> fk_mq0iewhji722rna3m050mwmfj <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_framework_fulfillment<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> framework_fulfillment <span class="br0">&#40;</span>id_framework_fulfillment<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">CONSTRAINT</span> uk_mq0iewhji722rna3m050mwmfj <span class="kw1">UNIQUE</span> <span class="br0">&#40;</span>id_flexible_element, id_framework_element<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- Revise budget default field design (#864)</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> budget_ratio_element
<span class="br0">&#40;</span>
  id_flexible_element <span class="kw5">bigint</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_spent_field <span class="kw5">bigint</span>,
  id_planned_field <span class="kw5">bigint</span>,
  <span class="kw1">CONSTRAINT</span> budget_ratio_element_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> budget_ratio_element_fkey1 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_spent_field<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> flexible_element <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> budget_ratio_element_fkey2 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_planned_field<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> flexible_element <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- Contact database (aka &quot;CRM&quot;) (#634)</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_model <span class="br0">&#40;</span>
  id_contact_model <span class="kw5">INTEGER</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>,
  id_organization <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>
    <span class="kw1">REFERENCES</span> organization<span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span>,
  <span class="kw1">type</span> VARCHAR<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">name</span> VARCHAR<span class="br0">&#40;</span><span class="nu0">8192</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  status VARCHAR<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  date_deleted <span class="kw5">TIMESTAMP</span> <span class="kw1">WITHOUT</span> <span class="kw5">TIME</span> <span class="kw1">ZONE</span>,
  date_maintenance <span class="kw5">TIMESTAMP</span> <span class="kw1">WITHOUT</span> <span class="kw5">TIME</span> <span class="kw1">ZONE</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_card <span class="br0">&#40;</span>
  id_contact_card <span class="kw5">INTEGER</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>,
  id_contact_model <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>
    <span class="kw1">REFERENCES</span> contact_model<span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span>
    <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  id_layout <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> layout<span class="br0">&#40;</span>id_layout<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_details <span class="br0">&#40;</span>
  id_contact_details <span class="kw5">INTEGER</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>,
  id_contact_model <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>
    <span class="kw1">REFERENCES</span> contact_model<span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span>
    <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  id_layout <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> layout<span class="br0">&#40;</span>id_layout<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> default_contact_flexible_element <span class="br0">&#40;</span>
  id_flexible_element <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>
    <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>
    <span class="kw1">REFERENCES</span> flexible_element <span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span>
    <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>,
  <span class="kw1">type</span> VARCHAR<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> contact_model_create_default_layout_constraint<span class="br0">&#40;</span>p_type <span class="kw5">VARCHAR</span>, p_id_layout_group <span class="kw5">INTEGER</span>, p_id_contact_model <span class="kw5">INTEGER</span>, p_sort_order <span class="kw5">INTEGER</span>, p_recycle_flexible_element_from_details <span class="kw5">BOOLEAN</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">INTEGER</span> <span class="kw1">AS</span> $$
    <span class="kw1">DECLARE</span>
        p_id_flexible_element <span class="kw5">INTEGER</span>;
        p_id_layout_constraint <span class="kw5">INTEGER</span>;
    <span class="kw1">BEGIN</span>
        p_id_layout_constraint :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">IF</span> p_recycle_flexible_element_from_details <span class="kw1">THEN</span>
            <span class="co1">-- Let's find the flexible element with the same type in the details layout</span>
            <span class="co1">-- Sharing the flexible element between card and details indicates to the application that a flexible</span>
            <span class="co1">-- element in the details layout appears in the contact card</span>
            <span class="kw1">SELECT</span> dcf.id_flexible_element <span class="kw1">INTO</span> p_id_flexible_element
            <span class="kw1">FROM</span> contact_details cd
            <span class="kw1">JOIN</span> layout_group dlg <span class="kw1">ON</span> <span class="br0">&#40;</span>dlg.id_layout <span class="sy0">=</span> cd.id_layout<span class="br0">&#41;</span>
            <span class="kw1">JOIN</span> layout_constraint dlc <span class="kw1">ON</span> <span class="br0">&#40;</span>dlc.id_layout_group <span class="sy0">=</span> dlg.id_layout_group<span class="br0">&#41;</span>
            <span class="kw1">JOIN</span> default_contact_flexible_element dcf <span class="kw1">ON</span> <span class="br0">&#40;</span>dcf.id_flexible_element <span class="sy0">=</span> dlc.id_flexible_element <span class="kw1">AND</span> dcf.<span class="kw1">type</span> <span class="sy0">=</span> p_type<span class="br0">&#41;</span>
            <span class="kw1">WHERE</span> cd.id_contact_model <span class="sy0">=</span> p_id_contact_model;
        <span class="kw1">ELSE</span>
            p_id_flexible_element :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
            <span class="kw1">INSERT</span> <span class="kw1">INTO</span> flexible_element <span class="br0">&#40;</span>id_flexible_element, amendable, validates, exportable, globally_exportable, creation_date<span class="br0">&#41;</span>
            <span class="kw1">SELECT</span> p_id_flexible_element, <span class="kw1">false</span>, <span class="kw1">false</span>, <span class="kw1">true</span>, <span class="kw1">false</span>, <span class="kw3">NOW</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
&nbsp;
            <span class="kw1">INSERT</span> <span class="kw1">INTO</span> default_contact_flexible_element <span class="br0">&#40;</span>id_flexible_element, <span class="kw1">type</span><span class="br0">&#41;</span>
            <span class="kw1">SELECT</span> p_id_flexible_element, p_type;
        <span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_constraint <span class="br0">&#40;</span>id_layout_constraint, sort_order, id_flexible_element, id_layout_group<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_layout_constraint, p_sort_order, p_id_flexible_element, p_id_layout_group;
&nbsp;
        <span class="kw1">RETURN</span> p_id_layout_constraint;
    <span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> contact_model_create_card_and_details<span class="br0">&#40;</span>p_id_contact_model <span class="kw5">INTEGER</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> VOID <span class="kw1">AS</span> $$
    <span class="kw1">DECLARE</span>
        p_id_contact_card <span class="kw5">INTEGER</span>;
        p_id_contact_card_layout <span class="kw5">INTEGER</span>;
        p_id_contact_photo_layout_group <span class="kw5">INTEGER</span>;
        p_id_contact_card_layout_group <span class="kw5">INTEGER</span>;
        p_id_contact_details <span class="kw5">INTEGER</span>;
        p_id_contact_details_layout <span class="kw5">INTEGER</span>;
        p_id_contact_details_layout_group <span class="kw5">INTEGER</span>;
        p_type <span class="kw5">VARCHAR</span>;
        p_counter <span class="kw5">INTEGER</span>;
    <span class="kw1">BEGIN</span>
        <span class="co1">-- ContactDetails creation</span>
        p_id_contact_details :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
        p_id_contact_details_layout :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
        p_id_contact_details_layout_group :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout <span class="br0">&#40;</span>id_layout, columns_count, rows_count<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_details_layout, <span class="nu0">1</span>, <span class="nu0">1</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_group <span class="br0">&#40;</span>id_layout_group, column_index, row_index, title, id_layout<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_details_layout_group, <span class="nu0">0</span>, <span class="nu0">0</span>, <span class="st0">'Default details group'</span>, p_id_contact_details_layout;
&nbsp;
        p_counter :<span class="sy0">=</span> <span class="nu0">1</span>;
        FOREACH p_type <span class="kw1">IN</span> <span class="kw5">ARRAY</span> <span class="kw5">ARRAY</span><span class="br0">&#91;</span><span class="st0">'FAMILY_NAME'</span>, <span class="st0">'FIRST_NAME'</span>, <span class="st0">'ORGANIZATION_NAME'</span>, <span class="st0">'MAIN_ORG_UNIT'</span>, <span class="st0">'SECONDARY_ORG_UNITS'</span>, <span class="st0">'CREATION_DATE'</span>, <span class="st0">'LOGIN'</span>, <span class="st0">'EMAIL_ADDRESS'</span>, <span class="st0">'PHONE_NUMBER'</span>, <span class="st0">'POSTAL_ADDRESS'</span>, <span class="st0">'PHOTO'</span>, <span class="st0">'COUNTRY'</span>, <span class="st0">'DIRECT_MEMBERSHIP'</span>, <span class="st0">'TOP_MEMBERSHIP'</span><span class="br0">&#93;</span>
        <span class="kw1">LOOP</span>
            PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span>p_type, p_id_contact_details_layout_group, p_id_contact_model, p_counter, <span class="kw1">false</span><span class="br0">&#41;</span>;
            p_counter :<span class="sy0">=</span> p_counter + <span class="nu0">1</span>;
        <span class="kw1">END</span> <span class="kw1">LOOP</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> contact_details <span class="br0">&#40;</span>id_contact_details, id_contact_model, id_layout<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_details, p_id_contact_model, p_id_contact_details_layout;
&nbsp;
        <span class="co1">-- ContactCard creation</span>
        p_id_contact_card :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
        p_id_contact_card_layout :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout <span class="br0">&#40;</span>id_layout, columns_count, rows_count<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_card_layout, <span class="nu0">2</span>, <span class="nu0">1</span>;
&nbsp;
        <span class="co1">-- Photo group</span>
        p_id_contact_photo_layout_group :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_group <span class="br0">&#40;</span>id_layout_group, column_index, row_index, title, id_layout<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_photo_layout_group, <span class="nu0">0</span>, <span class="nu0">0</span>, <span class="st0">'Avatar group'</span>, p_id_contact_card_layout;
&nbsp;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'PHOTO'</span>, p_id_contact_photo_layout_group, p_id_contact_model, <span class="nu0">0</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="co1">-- Card information group</span>
        p_id_contact_card_layout_group :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_group <span class="br0">&#40;</span>id_layout_group, column_index, row_index, title, id_layout<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_card_layout_group, <span class="nu0">0</span>, <span class="nu0">1</span>, <span class="st0">'Default card group'</span>, p_id_contact_card_layout;
&nbsp;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'FAMILY_NAME'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">1</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'ORGANIZATION_NAME'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">1</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'FIRST_NAME'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">2</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'TOP_MEMBERSHIP'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">3</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'EMAIL_ADDRESS'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">4</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'PHONE_NUMBER'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">5</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'POSTAL_ADDRESS'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">6</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
        PERFORM contact_model_create_default_layout_constraint<span class="br0">&#40;</span><span class="st0">'COUNTRY'</span>, p_id_contact_card_layout_group, p_id_contact_model, <span class="nu0">7</span>, <span class="kw1">true</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> contact_card <span class="br0">&#40;</span>id_contact_card, id_contact_model, id_layout<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_card, p_id_contact_model, p_id_contact_card_layout;
    <span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> contact_model_create<span class="br0">&#40;</span>p_id_organization <span class="kw5">INTEGER</span>, p_type <span class="kw5">VARCHAR</span>, p_name <span class="kw5">VARCHAR</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">INTEGER</span> <span class="kw1">AS</span> $$
    <span class="kw1">DECLARE</span>
        p_id_contact_model <span class="kw5">INTEGER</span>;
    <span class="kw1">BEGIN</span>
        p_id_contact_model :<span class="sy0">=</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">INSERT</span> <span class="kw1">INTO</span> contact_model <span class="br0">&#40;</span>id_contact_model, <span class="kw1">name</span>, status, <span class="kw1">type</span>, id_organization<span class="br0">&#41;</span>
        <span class="kw1">SELECT</span> p_id_contact_model, p_name, <span class="st0">'USED'</span>, p_type, p_id_organization;
&nbsp;
        PERFORM contact_model_create_card_and_details<span class="br0">&#40;</span>p_id_contact_model<span class="br0">&#41;</span>;
&nbsp;
        <span class="kw1">RETURN</span> p_id_contact_model;
    <span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact <span class="br0">&#40;</span>
  id_contact <span class="kw5">INTEGER</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>,
  id_contact_model <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">REFERENCES</span> contact_model<span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span>,
  id_user <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> userlogin<span class="br0">&#40;</span>userid<span class="br0">&#41;</span>,
  id_organization <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> organization<span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span>,
  <span class="kw1">name</span> <span class="kw5">VARCHAR</span>,
  firstname <span class="kw5">VARCHAR</span>,
  id_main_org_unit <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> partner<span class="br0">&#40;</span>partnerid<span class="br0">&#41;</span>,
  <span class="kw1">login</span> <span class="kw5">VARCHAR</span>,
  email <span class="kw5">VARCHAR</span>,
  phone_number <span class="kw5">VARCHAR</span>,
  postal_address <span class="kw5">VARCHAR</span>,
  photo <span class="kw5">VARCHAR</span>,
  id_country <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> country<span class="br0">&#40;</span>countryid<span class="br0">&#41;</span>,
  id_parent <span class="kw5">INTEGER</span> <span class="kw1">REFERENCES</span> contact<span class="br0">&#40;</span>id_contact<span class="br0">&#41;</span>,
  date_created <span class="kw5">TIMESTAMP</span> <span class="kw1">WITHOUT</span> <span class="kw5">TIME</span> <span class="kw1">ZONE</span>,
  date_deleted <span class="kw5">TIMESTAMP</span> <span class="kw1">WITHOUT</span> <span class="kw5">TIME</span> <span class="kw1">ZONE</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> contact_check_type <span class="br0">&#40;</span>p_id_user <span class="kw5">INTEGER</span>, p_id_organization <span class="kw5">INTEGER</span>, p_id_contact_model <span class="kw5">INTEGER</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">BOOLEAN</span> <span class="kw1">AS</span> $$
    <span class="kw1">DECLARE</span>
        p_valid <span class="kw5">BOOLEAN</span>;
    <span class="kw1">BEGIN</span>
        <span class="kw1">IF</span> p_id_user <span class="kw1">IS</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">AND</span> p_id_organization <span class="kw1">IS</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">THEN</span>
            <span class="co1">-- This contact is both related to a user and an organization</span>
            <span class="co1">-- This is not valid</span>
            p_valid <span class="sy0">=</span> <span class="kw1">false</span>;
        ELSIF p_id_user <span class="kw1">IS</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">THEN</span>
            <span class="co1">-- The related model should be an 'INDIVIDUAL' model</span>
            <span class="kw1">SELECT</span> <span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'INDIVIDUAL'</span> <span class="kw1">INTO</span> p_valid
            <span class="kw1">FROM</span> contact_model
            <span class="kw1">WHERE</span> id_contact_model <span class="sy0">=</span> p_id_contact_model;
        ELSIF p_id_organization <span class="kw1">IS</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">THEN</span>
            <span class="co1">-- The related model should be an 'ORGANIZATION' model</span>
            <span class="kw1">SELECT</span> <span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'ORGANIZATION'</span> <span class="kw1">INTO</span> p_valid
            <span class="kw1">FROM</span> contact_model
            <span class="kw1">WHERE</span> id_contact_model <span class="sy0">=</span> p_id_contact_model;
        <span class="kw1">ELSE</span>
            <span class="co1">-- Not related to a user or an organization</span>
            <span class="co1">-- the type of the related model can either be 'INDIVIDUAL' or 'ORGANIZATION'</span>
            p_valid <span class="sy0">=</span> <span class="kw1">true</span>;
        <span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
        <span class="kw1">RETURN</span> p_valid;
    <span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> is_parent_an_organization <span class="br0">&#40;</span>p_id_contact <span class="kw5">INTEGER</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">BOOLEAN</span> <span class="kw1">AS</span> $$
    <span class="kw1">SELECT</span> cm.id_contact_model <span class="kw1">IS</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>
    <span class="kw1">FROM</span> contact c
    <span class="kw1">LEFT</span> <span class="kw1">JOIN</span> contact_model cm <span class="kw1">ON</span> <span class="br0">&#40;</span>c.id_contact_model <span class="sy0">=</span> c.id_contact_model <span class="kw1">AND</span> cm.<span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'ORGANIZATION'</span><span class="br0">&#41;</span>
    <span class="kw1">WHERE</span> c.id_contact <span class="sy0">=</span> p_id_contact;
$$ <span class="kw1">LANGUAGE</span> SQL;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> contact
  <span class="kw1">ADD</span> <span class="kw1">CONSTRAINT</span> is_parent_an_organization_constraint
  <span class="kw1">CHECK</span> <span class="br0">&#40;</span>is_parent_an_organization<span class="br0">&#40;</span>id_parent<span class="br0">&#41;</span><span class="br0">&#41;</span> ;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> contact
  <span class="kw1">ADD</span> <span class="kw1">CONSTRAINT</span> check_type_constraint
  <span class="kw1">CHECK</span> <span class="br0">&#40;</span>contact_check_type<span class="br0">&#40;</span>id_user, id_organization, id_contact_model<span class="br0">&#41;</span><span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_unit <span class="br0">&#40;</span>
  id_contact <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">REFERENCES</span> contact<span class="br0">&#40;</span>id_contact<span class="br0">&#41;</span>,
  id_org_unit <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">REFERENCES</span> partner<span class="br0">&#40;</span>partnerid<span class="br0">&#41;</span>,
  <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_contact, id_org_unit<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_list_element <span class="br0">&#40;</span>
  id_flexible_element <span class="kw5">BIGINT</span>
    <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>
    <span class="kw1">REFERENCES</span> flexible_element<span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span>,
  allowed_type <span class="kw5">VARCHAR</span>,
  contact_limit <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="nu0">0</span>,
  is_member <span class="kw5">BOOLEAN</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="kw1">false</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> contact_list_element_model <span class="br0">&#40;</span>
  id_flexible_element <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">REFERENCES</span> contact_list_element<span class="br0">&#40;</span>id_flexible_element<span class="br0">&#41;</span>,
  id_contact_model <span class="kw5">INTEGER</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">REFERENCES</span> contact_model<span class="br0">&#40;</span>id_contact_model<span class="br0">&#41;</span>,
  <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_flexible_element, id_contact_model<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> global_contact_export
<span class="br0">&#40;</span>
  id <span class="kw5">bigint</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  generated_date <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  organization_id <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_organization_fkey <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>organization_id<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> organization <span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> global_contact_export_content
<span class="br0">&#40;</span>
  id <span class="kw5">bigint</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  csv_content <span class="kw5">text</span>,
  contact_model_name <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">8192</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  global_export_id <span class="kw5">bigint</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_content_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_content_global_export_fkey <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>global_export_id<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> global_contact_export <span class="br0">&#40;</span>id<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> global_contact_export_settings
<span class="br0">&#40;</span>
  id <span class="kw5">bigint</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  auto_delete_frequency <span class="kw5">integer</span>,
  auto_export_frequency <span class="kw5">integer</span>,
  default_organization_export_format <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>,
  export_format <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>,
  last_export_date <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span>,
  locale_string <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  organization_id <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_settings_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> global_contact_export_settings_organization_fkey <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>organization_id<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> organization <span class="br0">&#40;</span>id_organization<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- Extension required to search for similar but not exactly equal contact duplicates (part of issue #634)</span>
<span class="kw1">CREATE</span> EXTENSION <span class="kw1">IF</span> <span class="kw1">NOT</span> <span class="kw1">EXISTS</span> pg_trgm; 
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> contact_fullname_idx <span class="kw1">ON</span> contact <span class="kw1">USING</span> gin<span class="br0">&#40;</span><span class="kw3">LOWER</span><span class="br0">&#40;</span><span class="kw1">name</span><span class="sy0">||</span><span class="st0">' '</span><span class="sy0">||</span>firstname<span class="br0">&#41;</span> gin_trgm_ops<span class="br0">&#41;</span>;
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> contact_email_idx <span class="kw1">ON</span> contact <span class="br0">&#40;</span><span class="kw3">LOWER</span><span class="br0">&#40;</span>email<span class="br0">&#41;</span><span class="br0">&#41;</span>;
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> userlogin_fullname_idx <span class="kw1">ON</span> userlogin <span class="kw1">USING</span> gin<span class="br0">&#40;</span><span class="kw3">LOWER</span><span class="br0">&#40;</span><span class="kw1">name</span><span class="sy0">||</span><span class="st0">' '</span><span class="sy0">||</span>firstname<span class="br0">&#41;</span> gin_trgm_ops<span class="br0">&#41;</span>;
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> userlogin_email_idx <span class="kw1">ON</span> userlogin <span class="br0">&#40;</span><span class="kw3">LOWER</span><span class="br0">&#40;</span>email<span class="br0">&#41;</span><span class="br0">&#41;</span>;
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> organization_name_idx <span class="kw1">ON</span> organization <span class="kw1">USING</span> gin<span class="br0">&#40;</span><span class="kw3">LOWER</span><span class="br0">&#40;</span><span class="kw1">name</span><span class="br0">&#41;</span> gin_trgm_ops<span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">-- Group iterations (#501)</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> layout_group_iteration <span class="br0">&#40;</span>
  id_layout_group_iteration <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_layout_group <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_container <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">name</span> varchar<span class="br0">&#40;</span><span class="nu0">30</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">CONSTRAINT</span> layout_group_iteration_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_layout_group_iteration<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> layout_group_iteration_id_layout_group_fkey <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_layout_group<span class="br0">&#41;</span>
    <span class="kw1">REFERENCES</span> layout_group <span class="br0">&#40;</span>id_layout_group<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
    <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">CASCADE</span>
<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> does_layout_group_have_iterations <span class="br0">&#40;</span>p_id_layout_group <span class="kw5">integer</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">boolean</span> <span class="kw1">AS</span> $$
  <span class="kw1">DECLARE</span>
    p_has_iterations <span class="kw5">boolean</span>;
  <span class="kw1">BEGIN</span>
    <span class="kw1">SELECT</span> has_iterations <span class="kw1">INTO</span> p_has_iterations
    <span class="kw1">FROM</span> layout_group
    <span class="kw1">WHERE</span> id_layout_group <span class="sy0">=</span> p_id_layout_group;
&nbsp;
    <span class="kw1">RETURN</span> p_has_iterations;
  <span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> layout_group_iteration
  <span class="kw1">ADD</span> <span class="kw1">CONSTRAINT</span> does_layout_group_have_iterations_constraint
  <span class="kw1">CHECK</span> <span class="br0">&#40;</span>does_layout_group_have_iterations<span class="br0">&#40;</span>id_layout_group<span class="br0">&#41;</span><span class="br0">&#41;</span> ;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> layout_group <span class="kw1">ADD</span> has_iterations <span class="kw5">boolean</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="kw1">false</span>;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="kw1">value</span> <span class="kw1">ADD</span> id_layout_group_iteration <span class="kw5">integer</span>;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="kw1">value</span> <span class="kw1">DROP</span> <span class="kw1">CONSTRAINT</span> value_id_flexible_element_key;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="kw1">value</span> <span class="kw1">ADD</span> <span class="kw1">CONSTRAINT</span> uk_ev3lt5f4afcgkonu6exlm9be8
  <span class="kw1">UNIQUE</span> <span class="br0">&#40;</span>id_flexible_element, id_project, id_layout_group_iteration<span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> history_token <span class="kw1">ADD</span> id_layout_group_iteration <span class="kw5">integer</span>;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> iteration_history_token
<span class="br0">&#40;</span>
  id_iteration_history_token <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  history_date <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_layout_group_iteration <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_layout_group <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  id_project <span class="kw5">integer</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">name</span> varchar<span class="br0">&#40;</span><span class="nu0">30</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  core_version <span class="kw5">integer</span>,
  <span class="kw1">CONSTRAINT</span> iteration_history_token_pkey <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_iteration_history_token<span class="br0">&#41;</span>,
  <span class="kw1">CONSTRAINT</span> fk_iteration_history_token_core_version <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>core_version<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> amendment <span class="br0">&#40;</span>id_amendment<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>,
  <span class="kw1">CONSTRAINT</span> fk_iteration_history_token_layout_group <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>id_layout_group<span class="br0">&#41;</span>
      <span class="kw1">REFERENCES</span> layout_group <span class="br0">&#40;</span>id_layout_group<span class="br0">&#41;</span> <span class="kw1">MATCH</span> <span class="kw1">SIMPLE</span>
      <span class="kw1">ON</span> <span class="kw1">UPDATE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> <span class="kw1">NO</span> <span class="kw1">ACTION</span>
<span class="br0">&#41;</span>;</pre>
</dd></dl>

</div>

<h2 class="sectionedit6" id="existing_data_updates">2. Existing data updates</h2>
<div class="level2">

<p>
<strong>After the schema is updated</strong>, in order to update the existing data, you need to run the SQL commands below:
</p>
<dl class="code">
<dt><a href="sigmah-dataupdates-v2.26253.sql?do=export_code&amp;id=contributorguide:schemachangelog&amp;codeblock=2" title="Download Snippet" class="mediafile mf_sql">sigmah-dataupdates-v2.2.sql</a></dt>
<dd><pre class="code postgresql"><span class="co1">-- Add Kosovo country in Sigmah list of countries</span>
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> Country <span class="br0">&#40;</span>CountryId, x1, x2, y1, y2, ISO2, <span class="kw1">Name</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">496</span>, -<span class="nu0">180</span>, <span class="nu0">180</span>, -<span class="nu0">90</span>, <span class="nu0">180</span>, <span class="st0">'XK'</span>, <span class="st0">'Kosovo'</span><span class="br0">&#41;</span>;
&nbsp;
&nbsp;
<span class="co1">--</span>
<span class="co1">-- Migrate all old budget fields into v2.2 new budget ratio format</span>
<span class="co1">-- </span>
<span class="co1">--</span>
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> migrate_budget_fields<span class="br0">&#40;</span>p_droptables <span class="kw5">boolean</span> <span class="kw1">default</span> <span class="kw1">false</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">INTEGER</span> <span class="kw1">AS</span> $$
<span class="kw1">DECLARE</span>	
	<span class="co1">--</span>
	<span class="co1">-- Get budget_element fields</span>
	<span class="co1">--</span>
	budget_elements_cursor <span class="kw1">CURSOR</span> <span class="kw1">FOR</span>
		<span class="kw1">SELECT</span> be.id_flexible_element old_id_flexible_element, be.id_ratio_divisor old_subfield_id_ratio_divisor, be.id_ratio_dividend old_subfield_id_ratio_dividend, 
			lc.id_layout_constraint, lc.id_layout_group, lc.sort_order, <span class="kw1">NULL</span> <span class="kw1">as</span> new_id_flexible_element, <span class="kw1">NULL</span> <span class="kw1">as</span> new_id_element_divisor, <span class="kw1">NULL</span> <span class="kw1">as</span> new_id_element_dividend
		<span class="kw1">FROM</span> budget_element be
			<span class="kw1">inner</span> <span class="kw1">join</span> layout_constraint lc <span class="kw1">on</span> lc.id_flexible_element <span class="sy0">=</span> be.id_flexible_element
			<span class="kw1">inner</span> <span class="kw1">join</span> layout_group lg <span class="kw1">on</span> lg.id_layout_group <span class="sy0">=</span> lc.id_layout_group
		<span class="kw1">WHERE</span> lg.id_layout <span class="kw1">not</span> <span class="kw1">in</span> <span class="br0">&#40;</span><span class="kw1">select</span> id_layout <span class="kw1">from</span> project_banner <span class="kw1">union</span> <span class="kw1">select</span> id_layout <span class="kw1">from</span> org_unit_banner<span class="br0">&#41;</span>;
	budget_element_record RECORD;
&nbsp;
	budget_layout_constraint_banner_cursor <span class="kw1">CURSOR</span> <span class="kw1">FOR</span>
		<span class="kw1">SELECT</span> lc.id_layout_constraint
		<span class="kw1">FROM</span> budget_element be
			<span class="kw1">inner</span> <span class="kw1">join</span> layout_constraint lc <span class="kw1">on</span> lc.id_flexible_element <span class="sy0">=</span> be.id_flexible_element
			<span class="kw1">inner</span> <span class="kw1">join</span> layout_group lg <span class="kw1">on</span> lg.id_layout_group <span class="sy0">=</span> lc.id_layout_group
		<span class="kw1">WHERE</span> lg.id_layout <span class="kw1">in</span> <span class="br0">&#40;</span><span class="kw1">select</span> id_layout <span class="kw1">from</span> project_banner <span class="kw1">union</span> <span class="kw1">select</span> id_layout <span class="kw1">from</span> org_unit_banner<span class="br0">&#41;</span>;
	budget_layout_constraint_banner_record RECORD;
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- Get budget history values</span>
	<span class="co1">--</span>
	budget_history_values_cursor <span class="kw1">CURSOR</span> <span class="kw1">FOR</span>
	<span class="kw1">SELECT</span> ht.id_history_token, ht.history_date, ht.id_element, ht.id_project, ht.change_type, ht.<span class="kw1">value</span>, ht.id_user, ht.<span class="kw1">comment</span>, ht.core_version, aht.amendment_id_amendment
	<span class="kw1">FROM</span> history_token ht
		<span class="kw1">inner</span> <span class="kw1">join</span> budget_element be <span class="kw1">on</span> be.id_flexible_element <span class="sy0">=</span> ht.id_element
		<span class="kw1">left</span> <span class="kw1">outer</span> <span class="kw1">join</span> amendment_history_token aht <span class="kw1">on</span> aht.values_id_history_token <span class="sy0">=</span> ht.id_history_token
	<span class="kw1">ORDER</span> <span class="kw1">BY</span> history_date, id_history_token;
	budget_history_values_record RECORD;
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- Get budget importation scheme mapping</span>
	<span class="co1">--</span>
	budget_importation_mapping_cursor <span class="kw1">CURSOR</span> <span class="kw1">FOR</span>
	<span class="kw1">SELECT</span> ivbsf.id_budget_sub_field old_id_budget_sub_field, ivbsf.var_id, ivbsf.var_fle_id
	<span class="kw1">FROM</span> importation_variable_budget_sub_field ivbsf ;
	budget_importation_mapping_record RECORD;
&nbsp;
	v_result <span class="kw5">INTEGER</span>;
	v_tmp_id <span class="kw5">INTEGER</span>;
	v_planned_id <span class="kw5">INTEGER</span>;
	v_spent_id <span class="kw5">INTEGER</span>;
	v_received_id <span class="kw5">INTEGER</span>;
	v_newplanned_id <span class="kw5">INTEGER</span>;
	v_newspent_id <span class="kw5">INTEGER</span>;
	v_newreceived_id <span class="kw5">INTEGER</span>;
	v_value <span class="kw5">TEXT</span>;
	v_oldvalue <span class="kw5">TEXT</span>;
	v_droptruncate_action <span class="kw5">TEXT</span>;
<span class="kw1">BEGIN</span>	
	v_result :<span class="sy0">=</span> <span class="nu0">0</span>;
&nbsp;
	<span class="co1">-- temp table to keep all mapping between old and new ids</span>
	<span class="kw1">CREATE</span> <span class="kw1">TEMPORARY</span> <span class="kw1">TABLE</span> tmp_migrate_budget_field <span class="kw1">AS</span>
	<span class="kw1">SELECT</span> be.id_flexible_element old_id_flexible_element, 
		be.id_ratio_divisor old_subfield_id_ratio_divisor, be.id_ratio_dividend old_subfield_id_ratio_dividend, <span class="nu0">0</span> <span class="kw1">as</span> old_subfield_id_received,
		lc.id_layout_constraint, lc.id_layout_group, lc.sort_order, 
		<span class="nu0">0</span> <span class="kw1">as</span> new_id_flexible_element, <span class="nu0">0</span> <span class="kw1">as</span> new_id_element_divisor, <span class="nu0">0</span> <span class="kw1">as</span> new_id_element_dividend, <span class="nu0">0</span> <span class="kw1">as</span> new_id_element_received
	<span class="kw1">FROM</span> budget_element be
		<span class="kw1">inner</span> <span class="kw1">join</span> layout_constraint lc <span class="kw1">on</span> lc.id_flexible_element <span class="sy0">=</span> be.id_flexible_element
		<span class="kw1">inner</span> <span class="kw1">join</span> layout_group lg <span class="kw1">on</span> lg.id_layout_group <span class="sy0">=</span> lc.id_layout_group
	<span class="kw1">WHERE</span> lg.id_layout <span class="kw1">not</span> <span class="kw1">in</span> <span class="br0">&#40;</span><span class="kw1">select</span> id_layout <span class="kw1">from</span> project_banner <span class="kw1">union</span> <span class="kw1">select</span> id_layout <span class="kw1">from</span> org_unit_banner<span class="br0">&#41;</span>;		
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- 1. CREATE BUDGET RATIO FIELDS</span>
	<span class="co1">--</span>
	<span class="kw1">FOR</span> budget_element_record <span class="kw1">IN</span> budget_elements_cursor 
	<span class="kw1">LOOP</span>	
		<span class="co1">-- --</span>
		<span class="co1">-- sort_order management: leave room for the new fields</span>
		<span class="kw1">UPDATE</span> layout_constraint
			<span class="kw1">SET</span> sort_order <span class="sy0">=</span> sort_order + <span class="nu0">3</span>
			<span class="kw1">WHERE</span> id_layout_group <span class="sy0">=</span> budget_element_record.id_layout_group <span class="kw1">and</span> sort_order <span class="sy0">&gt;</span> budget_element_record.sort_order;
&nbsp;
		<span class="co1">-- --</span>
		<span class="co1">-- create divisor number field (&quot;PLANNED&quot;)</span>
		<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span> <span class="kw1">INTO</span> v_tmp_id;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> flexible_element<span class="br0">&#40;</span>
				id_flexible_element, amendable, label, validates, id_privacy_group, 
				exportable, globally_exportable, creation_date, is_disabled, 
				disabled_date, code<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> v_tmp_id, fe.amendable, <span class="st0">'Planned budget'</span>, fe.validates, fe.id_privacy_group,
				fe.exportable, fe.globally_exportable, fe.creation_date, fe.is_disabled,
				fe.disabled_date, <span class="kw3">COALESCE</span><span class="br0">&#40;</span>fe.code <span class="sy0">||</span> <span class="st0">'_planned'</span>, <span class="st0">'planned_'</span> <span class="sy0">||</span> v_tmp_id<span class="br0">&#41;</span>
			<span class="kw1">FROM</span> flexible_element fe
			<span class="kw1">WHERE</span> fe.id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> textarea_element <span class="br0">&#40;</span>is_decimal, <span class="kw1">type</span>, id_flexible_element<span class="br0">&#41;</span>
			VALUES<span class="br0">&#40;</span><span class="kw1">TRUE</span>, <span class="st0">'N'</span>, v_tmp_id<span class="br0">&#41;</span>;
		<span class="co1">-- &quot;spent budget&quot; set in new position just below old full budget field</span>
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_constraint<span class="br0">&#40;</span>
				id_layout_constraint, sort_order, id_flexible_element, id_layout_group<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, budget_element_record.sort_order + <span class="nu0">1</span>, v_tmp_id, budget_element_record.id_layout_group;
		<span class="kw1">UPDATE</span> tmp_migrate_budget_field 
			<span class="kw1">SET</span> new_id_element_divisor <span class="sy0">=</span> v_tmp_id 
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
&nbsp;
		<span class="co1">-- --</span>
		<span class="co1">-- create dividend number field (&quot;SPENT&quot;) (not amendable by default)</span>
		<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span> <span class="kw1">INTO</span> v_tmp_id;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> flexible_element<span class="br0">&#40;</span>
				id_flexible_element, amendable, label, validates, id_privacy_group, 
				exportable, globally_exportable, creation_date, is_disabled, 
				disabled_date, code<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> v_tmp_id, <span class="kw1">false</span>, <span class="st0">'Spent budget'</span>, fe.validates, fe.id_privacy_group,
				fe.exportable, fe.globally_exportable, fe.creation_date, fe.is_disabled,
				fe.disabled_date, <span class="kw3">COALESCE</span><span class="br0">&#40;</span>fe.code <span class="sy0">||</span> <span class="st0">'_spent'</span>, <span class="st0">'spent_'</span> <span class="sy0">||</span> v_tmp_id<span class="br0">&#41;</span>
			<span class="kw1">FROM</span> flexible_element fe
			<span class="kw1">WHERE</span> fe.id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> textarea_element <span class="br0">&#40;</span>is_decimal, <span class="kw1">type</span>, id_flexible_element<span class="br0">&#41;</span>
			VALUES<span class="br0">&#40;</span><span class="kw1">TRUE</span>, <span class="st0">'N'</span>, v_tmp_id<span class="br0">&#41;</span>;
		<span class="co1">-- &quot;planned budget&quot; set in new position just two points below old full budget field</span>
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_constraint<span class="br0">&#40;</span>
				id_layout_constraint, sort_order, id_flexible_element, id_layout_group<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, budget_element_record.sort_order + <span class="nu0">2</span>, v_tmp_id, budget_element_record.id_layout_group;
		<span class="kw1">UPDATE</span> tmp_migrate_budget_field 
			<span class="kw1">SET</span> new_id_element_dividend <span class="sy0">=</span> v_tmp_id 
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
&nbsp;
		<span class="co1">-- --</span>
		<span class="co1">-- create received number field (&quot;RECEIVED&quot;) (not amendable by default)</span>
		<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span> <span class="kw1">INTO</span> v_tmp_id;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> flexible_element<span class="br0">&#40;</span>
				id_flexible_element, amendable, label, validates, id_privacy_group, 
				exportable, globally_exportable, creation_date, is_disabled, 
				disabled_date, code<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> v_tmp_id, <span class="kw1">false</span>, <span class="st0">'Received budget'</span>, fe.validates, fe.id_privacy_group,
				fe.exportable, fe.globally_exportable, fe.creation_date, fe.is_disabled,
				fe.disabled_date, <span class="kw3">COALESCE</span><span class="br0">&#40;</span>fe.code <span class="sy0">||</span> <span class="st0">'_received'</span>, <span class="st0">'received_'</span> <span class="sy0">||</span> v_tmp_id<span class="br0">&#41;</span>
			<span class="kw1">FROM</span> flexible_element fe
			<span class="kw1">WHERE</span> fe.id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> textarea_element <span class="br0">&#40;</span>is_decimal, <span class="kw1">type</span>, id_flexible_element<span class="br0">&#41;</span>
			VALUES<span class="br0">&#40;</span><span class="kw1">TRUE</span>, <span class="st0">'N'</span>, v_tmp_id<span class="br0">&#41;</span>;
		<span class="co1">-- &quot;received budget&quot; set in new position three points below old full budget field</span>
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> layout_constraint<span class="br0">&#40;</span>
				id_layout_constraint, sort_order, id_flexible_element, id_layout_group<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, budget_element_record.sort_order + <span class="nu0">3</span>, v_tmp_id, budget_element_record.id_layout_group;
		<span class="kw1">UPDATE</span> tmp_migrate_budget_field 
			<span class="kw1">SET</span> new_id_element_received <span class="sy0">=</span> v_tmp_id,
				old_subfield_id_received <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_budget_sub_field
								<span class="kw1">FROM</span> budget_sub_field 
								<span class="kw1">WHERE</span> <span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'RECEIVED'</span> 
									<span class="kw1">and</span> id_budget_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element <span class="br0">&#41;</span>
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
&nbsp;
&nbsp;
		<span class="co1">-- --</span>
		<span class="co1">-- create budget ratio default field</span>
		<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span> <span class="kw1">INTO</span> v_tmp_id;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> flexible_element<span class="br0">&#40;</span>
				id_flexible_element, amendable, label, validates, id_privacy_group, 
				exportable, globally_exportable, creation_date, is_disabled, 
				disabled_date, code<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> v_tmp_id, fe.amendable, <span class="st0">'Budget consumption'</span>, fe.validates, fe.id_privacy_group,
				fe.exportable, fe.globally_exportable, fe.creation_date, fe.is_disabled,
				fe.disabled_date, fe.code
			<span class="kw1">FROM</span> flexible_element fe
			<span class="kw1">WHERE</span> fe.id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> budget_ratio_element <span class="br0">&#40;</span>id_flexible_element, id_spent_field, id_planned_field<span class="br0">&#41;</span>
			<span class="kw1">SELECT</span> v_tmp_id, new_id_element_dividend,  new_id_element_divisor
			<span class="kw1">FROM</span> tmp_migrate_budget_field
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> default_flexible_element<span class="br0">&#40;</span><span class="kw1">type</span>, id_flexible_element<span class="br0">&#41;</span>
			<span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="st0">'BUDGET_RATIO'</span>, v_tmp_id<span class="br0">&#41;</span>;
		<span class="co1">-- &quot;budget ratio&quot; field set in same position as old full budget field</span>
		<span class="kw1">UPDATE</span> layout_constraint
			<span class="kw1">SET</span> id_flexible_element <span class="sy0">=</span> v_tmp_id				 
			<span class="kw1">WHERE</span> id_layout_group <span class="sy0">=</span> budget_element_record.id_layout_group <span class="kw1">and</span> id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
		<span class="kw1">UPDATE</span> tmp_migrate_budget_field 
			<span class="kw1">SET</span> new_id_flexible_element <span class="sy0">=</span> v_tmp_id 
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_element_record.old_id_flexible_element;
&nbsp;
	<span class="kw1">END</span> <span class="kw1">LOOP</span>;	
	<span class="co1">-- --</span>
	<span class="co1">-- update banners</span>
	<span class="kw1">FOR</span> budget_layout_constraint_banner_record <span class="kw1">IN</span> budget_layout_constraint_banner_cursor 
	<span class="kw1">LOOP</span>
		<span class="kw1">UPDATE</span> layout_constraint lc
			<span class="kw1">SET</span> id_flexible_element <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">select</span> new_id_flexible_element 
						<span class="kw1">from</span> tmp_migrate_budget_field 
						<span class="kw1">where</span> old_id_flexible_element <span class="sy0">=</span> lc.id_flexible_element<span class="br0">&#41;</span>
			<span class="kw1">WHERE</span> lc.id_layout_constraint <span class="sy0">=</span> budget_layout_constraint_banner_record.id_layout_constraint;
	<span class="kw1">END</span> <span class="kw1">LOOP</span>;
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- 2. CREATE BUDGET RATIO VALUES AND MODIF HISTORY</span>
	<span class="co1">--</span>
	<span class="kw1">FOR</span> budget_history_values_record <span class="kw1">IN</span> budget_history_values_cursor
	<span class="kw1">LOOP</span>
		<span class="kw1">SELECT</span> old_subfield_id_ratio_divisor, old_subfield_id_ratio_dividend, old_subfield_id_received,
			new_id_element_divisor, new_id_element_dividend, new_id_element_received
			<span class="kw1">INTO</span> v_planned_id, v_spent_id, v_received_id, v_newplanned_id, v_newspent_id, v_newreceived_id
			<span class="kw1">FROM</span> tmp_migrate_budget_field
			<span class="kw1">WHERE</span> old_id_flexible_element <span class="sy0">=</span> budget_history_values_record.id_element;
&nbsp;
		<span class="kw1">IF</span> <span class="br0">&#40;</span> budget_history_values_record.change_type <span class="sy0">=</span> <span class="st0">'ADD'</span> <span class="br0">&#41;</span>
		<span class="kw1">THEN</span>
			<span class="co1">-- if old budget history change type is initial 'ADD', create initial value for each new field</span>
&nbsp;
			<span class="co1">-- planned</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_planned_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>			
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newplanned_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
			<span class="co1">-- spent</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_spent_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newspent_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
			<span class="co1">-- received</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_received_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newreceived_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
		<span class="kw1">ELSE</span>
			<span class="co1">-- if old budget history change type is 'EDIT', only update changed values</span>
&nbsp;
			<span class="co1">-- planned</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_planned_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">SELECT</span> <span class="kw1">value</span> 
				<span class="kw1">INTO</span> v_oldvalue 
				<span class="kw1">FROM</span> <span class="kw1">value</span> 
				<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> v_newplanned_id
					<span class="kw1">and</span> id_project <span class="sy0">=</span> budget_history_values_record.id_project;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span> <span class="kw1">and</span> <span class="br0">&#40;</span>v_value !<span class="sy0">=</span> v_oldvalue <span class="kw1">or</span> v_oldvalue <span class="kw1">is</span> <span class="kw1">NULL</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newplanned_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;				
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
			<span class="co1">-- spent</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_spent_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">SELECT</span> <span class="kw1">value</span> 
				<span class="kw1">INTO</span> v_oldvalue 
				<span class="kw1">FROM</span> <span class="kw1">value</span> 
				<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> v_newspent_id
					<span class="kw1">and</span> id_project <span class="sy0">=</span> budget_history_values_record.id_project;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span> <span class="kw1">and</span> <span class="br0">&#40;</span>v_value !<span class="sy0">=</span> v_oldvalue <span class="kw1">or</span> v_oldvalue <span class="kw1">is</span> <span class="kw1">NULL</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newspent_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;				
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
			<span class="co1">-- received</span>
			v_value :<span class="sy0">=</span> <span class="kw3">regexp_matches</span><span class="br0">&#40;</span>budget_history_values_record.<span class="kw1">value</span>, v_received_id <span class="sy0">||</span> <span class="st0">'%'</span> <span class="sy0">||</span> <span class="st0">'[0-9.]+'</span><span class="br0">&#41;</span>;
			v_value :<span class="sy0">=</span> <span class="kw3">split_part</span><span class="br0">&#40;</span><span class="kw3">trim</span><span class="br0">&#40;</span><span class="kw1">both</span> <span class="st0">'{}'</span> <span class="kw1">from</span> v_value<span class="br0">&#41;</span>,<span class="st0">'%'</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;
			<span class="kw1">SELECT</span> <span class="kw1">value</span> 
				<span class="kw1">INTO</span> v_oldvalue 
				<span class="kw1">FROM</span> <span class="kw1">value</span> 
				<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> v_newreceived_id
					<span class="kw1">and</span> id_project <span class="sy0">=</span> budget_history_values_record.id_project;
			<span class="kw1">IF</span> <span class="br0">&#40;</span>v_value <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">NULL</span> <span class="kw1">and</span> <span class="br0">&#40;</span>v_value !<span class="sy0">=</span> v_oldvalue <span class="kw1">or</span> v_oldvalue <span class="kw1">is</span> <span class="kw1">NULL</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				PERFORM update_field_anytime<span class="br0">&#40;</span>v_newreceived_id, v_value, budget_history_values_record.id_project, 
					budget_history_values_record.id_user, budget_history_values_record.<span class="kw1">comment</span>, budget_history_values_record.history_date, 
					budget_history_values_record.core_version, budget_history_values_record.amendment_id_amendment<span class="br0">&#41;</span>;				
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
		<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="kw1">END</span> <span class="kw1">LOOP</span>;	
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- 3. UPDATE IMPORTATION SCHEME</span>
	<span class="co1">--</span>
	<span class="kw1">FOR</span> budget_importation_mapping_record <span class="kw1">IN</span> budget_importation_mapping_cursor
	<span class="kw1">LOOP</span>
		v_tmp_id :<span class="sy0">=</span> <span class="nu0">0</span>;
		CASE<span class="br0">&#40;</span> get_field_type<span class="br0">&#40;</span>budget_importation_mapping_record.old_id_budget_sub_field<span class="br0">&#41;</span> <span class="br0">&#41;</span>
			<span class="kw1">WHEN</span> <span class="st0">'PLANNED'</span>
			<span class="kw1">THEN</span>
				<span class="kw1">SELECT</span> new_id_element_divisor
					<span class="kw1">INTO</span> v_tmp_id
					<span class="kw1">FROM</span> tmp_migrate_budget_field
					<span class="kw1">WHERE</span> old_subfield_id_ratio_divisor <span class="sy0">=</span> budget_importation_mapping_record.old_id_budget_sub_field;
			<span class="kw1">WHEN</span> <span class="st0">'SPENT'</span>
			<span class="kw1">THEN</span>
				<span class="kw1">SELECT</span> new_id_element_dividend
					<span class="kw1">INTO</span> v_tmp_id
					<span class="kw1">FROM</span> tmp_migrate_budget_field
					<span class="kw1">WHERE</span> old_subfield_id_ratio_dividend <span class="sy0">=</span> budget_importation_mapping_record.old_id_budget_sub_field;
			<span class="kw1">WHEN</span> <span class="st0">'RECEIVED'</span>
			<span class="kw1">THEN</span>
				<span class="kw1">SELECT</span> new_id_element_received
					<span class="kw1">INTO</span> v_tmp_id
					<span class="kw1">FROM</span> tmp_migrate_budget_field
					<span class="kw1">WHERE</span> old_subfield_id_received <span class="sy0">=</span> budget_importation_mapping_record.old_id_budget_sub_field;
		<span class="kw1">END</span> <span class="kw1">CASE</span>;
&nbsp;
		<span class="kw1">UPDATE</span> importation_scheme_variable_flexible_element
			<span class="kw1">SET</span> id_flexible_element <span class="sy0">=</span> v_tmp_id,
				var_id <span class="sy0">=</span> budget_importation_mapping_record.var_id
			<span class="kw1">WHERE</span> var_fle_id <span class="sy0">=</span> budget_importation_mapping_record.var_fle_id;
	<span class="kw1">END</span> <span class="kw1">LOOP</span>;
&nbsp;
&nbsp;
	<span class="co1">--</span>
	<span class="co1">-- 3. CHECK, CLEAN AND DELETE TABLES</span>
	<span class="co1">--</span>
	<span class="kw1">IF</span> <span class="br0">&#40;</span> p_droptables <span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		v_droptruncate_action :<span class="sy0">=</span> <span class="st0">'DROP'</span>;
	<span class="kw1">ELSE</span>
		v_droptruncate_action :<span class="sy0">=</span> <span class="st0">'TRUNCATE'</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="co1">-- clean importation_variable_budget_sub_field</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> importation_variable_budget_sub_field
		<span class="kw1">WHERE</span> id_budget_sub_field <span class="kw1">IN</span> <span class="br0">&#40;</span>	<span class="br0">&#40;</span><span class="kw1">SELECT</span> old_subfield_id_ratio_divisor <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>
					<span class="kw1">UNION</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_subfield_id_ratio_dividend <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>
					<span class="kw1">UNION</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_subfield_id_received <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>	<span class="br0">&#41;</span> ;
	<span class="kw1">SELECT</span> <span class="kw3">COUNT</span><span class="br0">&#40;</span>*<span class="br0">&#41;</span> <span class="kw1">INTO</span> v_result <span class="kw1">FROM</span> importation_variable_budget_sub_field;
	<span class="kw1">IF</span> <span class="br0">&#40;</span> v_result <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		RAISE EXCEPTION <span class="st0">'Some importation budget sub-fields mapping have not been migrated!'</span>;
	<span class="kw1">ELSE</span>
		PERFORM v_droptruncate_action <span class="sy0">||</span> <span class="st0">' TABLE importation_variable_budget_sub_field'</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="co1">-- clean importation_scheme_variable_budget_element</span>
	PERFORM v_droptruncate_action <span class="sy0">||</span> <span class="st0">' DROP TABLE importation_scheme_variable_budget_element'</span>;	
&nbsp;
	<span class="co1">-- clean budget_sub_field (see ratio to NULL in budget_element because cross FK constraints)</span>
	<span class="kw1">UPDATE</span> budget_element
		<span class="kw1">SET</span> id_ratio_divisor <span class="sy0">=</span> <span class="kw1">NULL</span>, id_ratio_dividend <span class="sy0">=</span> <span class="kw1">NULL</span>
		<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> budget_sub_field
		<span class="kw1">WHERE</span> id_budget_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
	<span class="kw1">SELECT</span> <span class="kw3">COUNT</span><span class="br0">&#40;</span>*<span class="br0">&#41;</span> <span class="kw1">INTO</span> v_result <span class="kw1">FROM</span> budget_sub_field;
	<span class="kw1">IF</span> <span class="br0">&#40;</span> v_result <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		RAISE EXCEPTION <span class="st0">'Some budget sub-fields have not been migrated!'</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="co1">-- clean budget_element</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> budget_element
		<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
	<span class="kw1">SELECT</span> <span class="kw3">COUNT</span><span class="br0">&#40;</span>*<span class="br0">&#41;</span> <span class="kw1">INTO</span> v_result <span class="kw1">FROM</span> budget_element;
	<span class="kw1">IF</span> <span class="br0">&#40;</span> v_result <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		RAISE EXCEPTION <span class="st0">'Some budget fields have not been migrated!'</span>;
	<span class="kw1">ELSE</span>
		PERFORM v_droptruncate_action <span class="sy0">||</span> <span class="st0">' TABLE budget_element, budget_sub_field'</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="co1">-- clean default_flexible_element</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> default_flexible_element
		<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
	<span class="kw1">SELECT</span> <span class="kw3">COUNT</span><span class="br0">&#40;</span>*<span class="br0">&#41;</span> <span class="kw1">INTO</span> v_result <span class="kw1">FROM</span> default_flexible_element <span class="kw1">WHERE</span> <span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'BUDGET'</span>;
	<span class="kw1">IF</span> <span class="br0">&#40;</span> v_result <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		RAISE EXCEPTION <span class="st0">'Some budget default fields have not been migrated!'</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="co1">-- clean value</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> <span class="kw1">value</span>
		<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
&nbsp;
	<span class="co1">-- clean amendment_history_token</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> amendment_history_token
		<span class="kw1">WHERE</span> values_id_history_token <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_history_token 
						<span class="kw1">FROM</span> history_token 
						<span class="kw1">WHERE</span> id_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element 
									<span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>
						<span class="br0">&#41;</span>;
&nbsp;
	<span class="co1">-- clean history_token</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> history_token
		<span class="kw1">WHERE</span> id_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
&nbsp;
	<span class="co1">-- clean flexible_element</span>
	<span class="kw1">DELETE</span> <span class="kw1">FROM</span> flexible_element
		<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> old_id_flexible_element <span class="kw1">FROM</span> tmp_migrate_budget_field<span class="br0">&#41;</span>;
&nbsp;
	<span class="kw1">RETURN</span> v_result;
<span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
<span class="co1">--</span>
<span class="co1">-- Return as a string the field type from any field (aka flexible element) id.</span>
<span class="co1">-- Also returns the budget sub-field type if a budget sub-field it is given.</span>
<span class="co1">--</span>
<span class="co1">-- Note: id_flexible_element and id_budget_sub_field have never the same value</span>
<span class="co1">--</span>
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> get_field_type<span class="br0">&#40;</span>p_field_id <span class="kw5">bigint</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span> <span class="kw1">AS</span> $$
<span class="kw1">DECLARE</span>
	v_type <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>;
<span class="kw1">BEGIN</span>
	<span class="kw1">SELECT</span> <span class="kw1">CASE</span>
		<span class="kw1">WHEN</span> p_field_id <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_flexible_element <span class="kw1">FROM</span> default_flexible_element<span class="br0">&#41;</span>
			<span class="kw1">THEN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="kw1">type</span> <span class="kw1">FROM</span> default_flexible_element <span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> p_field_id <span class="br0">&#41;</span>
		<span class="kw1">WHEN</span> p_field_id <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_budget_sub_field <span class="kw1">FROM</span> budget_sub_field<span class="br0">&#41;</span>
			<span class="kw1">THEN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="kw1">type</span> <span class="kw1">FROM</span> budget_sub_field <span class="kw1">WHERE</span> id_budget_sub_field <span class="sy0">=</span> p_field_id <span class="br0">&#41;</span>
		<span class="kw1">WHEN</span> p_field_id <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_question <span class="kw1">FROM</span> question_choice_element<span class="br0">&#41;</span> 
			<span class="kw1">THEN</span> <span class="st0">'QUESTION'</span>
		<span class="kw1">WHEN</span> p_field_id <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_flexible_element <span class="kw1">FROM</span> files_list_element<span class="br0">&#41;</span>
			<span class="kw1">THEN</span> <span class="st0">'FILES'</span>
		<span class="kw1">WHEN</span> p_field_id <span class="kw1">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id_flexible_element <span class="kw1">FROM</span> textarea_element<span class="br0">&#41;</span>
			<span class="kw1">THEN</span> <span class="kw1">CASE</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="kw1">type</span> <span class="kw1">FROM</span> textarea_element <span class="kw1">WHERE</span> id_flexible_element<span class="sy0">=</span>p_field_id<span class="br0">&#41;</span>
				<span class="kw1">WHEN</span> <span class="st0">'D'</span>
					<span class="kw1">THEN</span> <span class="st0">'DATE'</span>
				<span class="kw1">WHEN</span> <span class="st0">'N'</span>
					<span class="kw1">THEN</span> <span class="st0">'NUMBER'</span>
				<span class="kw1">WHEN</span> <span class="st0">'P'</span>
					<span class="kw1">THEN</span> <span class="st0">'PARAGRAPH'</span>
				<span class="kw1">WHEN</span> <span class="st0">'T'</span>
					<span class="kw1">THEN</span> <span class="st0">'TEXT'</span>
				<span class="kw1">END</span>
		<span class="kw1">ELSE</span> <span class="st0">'other'</span> <span class="kw1">END</span>
	<span class="kw1">INTO</span> v_type;
&nbsp;
&nbsp;
<span class="kw1">RETURN</span> v_type;
<span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> get_field_type<span class="br0">&#40;</span>p_field_id <span class="kw5">integer</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span> <span class="kw1">AS</span> $$
<span class="kw1">BEGIN</span>
	<span class="kw1">RETURN</span> get_field_type<span class="br0">&#40;</span>CAST<span class="br0">&#40;</span>p_field_id <span class="kw1">as</span> <span class="kw5">bigint</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
<span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
<span class="co1">--</span>
<span class="co1">-- Update the value of a field.</span>
<span class="co1">--</span>
<span class="co1">--    Impossible for field type 'OWNER', 'COUNTRY' and 'BUDGET'.</span>
<span class="co1">--    This function doesn't take into account field limits</span>
<span class="co1">--</span>
<span class="co1">-- Parameter format for p_field_value according to field type:</span>
<span class="co1">--   - START_DATE, END_DATE : date format like '25/12/2015'</span>
<span class="co1">--   - CODE : text, but no longer than 50 characters</span>
<span class="co1">--   - MANAGER : user id like '35'</span>
<span class="co1">--   - ORG_UNIT : partner id like '602'</span>
<span class="co1">--   - SPENT, RECEIVED, PLANNED: budget sub-field value like '25080' or '78450.23'</span>
<span class="co1">--   - DATE : date format like '25/12/2015'</span>
<span class="co1">--   - NUMBER : number like '25080' or '78450.23'</span>
<span class="co1">--   - TEXT : text like 'plusieurs mots'</span>
<span class="co1">--   - PARAGRAPH : one more more lines of text, each line of text must be separated only by a NEWLINE (ASCII code 10) character, like 'first line' || chr(10) || ' and second important line'</span>
<span class="kw1">CREATE</span> <span class="kw1">OR</span> <span class="kw1">REPLACE</span> <span class="kw1">FUNCTION</span> update_field_anytime<span class="br0">&#40;</span>p_field_id <span class="kw5">integer</span>, p_field_value <span class="kw5">text</span>, p_project_id <span class="kw5">integer</span>, p_author_id <span class="kw5">integer</span>, p_history_comment <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>, p_timestamp <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span>, p_core_version <span class="kw5">integer</span>, p_amendment_history_token <span class="kw5">integer</span><span class="br0">&#41;</span> <span class="kw1">RETURNS</span> <span class="kw5">boolean</span> <span class="kw1">AS</span> $$
<span class="kw1">DECLARE</span>
	v_type <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>;
	v_history_last_change_record RECORD;
	v_history_change_type <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>;
	v_action_last_modif character<span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>;
	v_budget_field_id <span class="kw5">integer</span>;
	v_value <span class="kw5">text</span>;
	v_history_date <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span>;
	v_id_history_token <span class="kw5">integer</span>;
<span class="kw1">BEGIN</span>
	v_type :<span class="sy0">=</span> get_field_type<span class="br0">&#40;</span>p_field_id<span class="br0">&#41;</span>;
	IF<span class="br0">&#40;</span>v_type <span class="sy0">=</span> <span class="st0">'PLANNED'</span> <span class="kw1">or</span> v_type <span class="sy0">=</span> <span class="st0">'SPENT'</span> <span class="kw1">or</span> v_type <span class="sy0">=</span> <span class="st0">'RECEIVED'</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		<span class="kw1">SELECT</span> id_budget_element <span class="kw1">INTO</span> v_budget_field_id <span class="kw1">FROM</span> budget_sub_field <span class="kw1">WHERE</span> id_budget_sub_field<span class="sy0">=</span>p_field_id; 
		<span class="kw1">SELECT</span> change_type, history_date
			<span class="kw1">INTO</span> v_history_last_change_record 
			<span class="kw1">FROM</span> history_token
			<span class="kw1">WHERE</span> id_element <span class="sy0">=</span> v_budget_field_id <span class="kw1">and</span> id_project <span class="sy0">=</span> p_project_id;
	<span class="kw1">ELSE</span>
		<span class="kw1">SELECT</span> change_type, history_date
			<span class="kw1">INTO</span> v_history_last_change_record 
			<span class="kw1">FROM</span> history_token
			<span class="kw1">WHERE</span> id_element <span class="sy0">=</span> p_field_id <span class="kw1">and</span> id_project <span class="sy0">=</span> p_project_id;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
	IF<span class="br0">&#40;</span>v_history_last_change_record <span class="kw1">IS</span> <span class="kw1">NULL</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		v_history_change_type :<span class="sy0">=</span> <span class="st0">'ADD'</span>;
		v_action_last_modif :<span class="sy0">=</span> <span class="st0">'C'</span>;
		v_history_date :<span class="sy0">=</span> p_timestamp;
	<span class="kw1">ELSE</span>
		v_history_change_type :<span class="sy0">=</span> <span class="st0">'EDIT'</span>;
		v_action_last_modif :<span class="sy0">=</span> <span class="st0">'U'</span>;
		<span class="kw1">IF</span> <span class="br0">&#40;</span>p_timestamp - v_history_last_change_record.history_date <span class="sy0">&lt;</span> <span class="kw5">interval</span> <span class="st0">'1 minute'</span><span class="br0">&#41;</span>
		<span class="kw1">THEN</span>
			v_history_date :<span class="sy0">=</span> v_history_last_change_record.history_date + <span class="kw5">interval</span> <span class="st0">'1 minute'</span>;
		<span class="kw1">ELSE</span>
			v_history_date :<span class="sy0">=</span> p_timestamp;
		<span class="kw1">END</span> <span class="kw1">IF</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
	<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span> <span class="kw1">INTO</span> v_id_history_token;
	<span class="kw1">CASE</span> v_type
		<span class="kw1">WHEN</span> <span class="st0">'START_DATE'</span>
			<span class="kw1">THEN</span>
			<span class="kw1">UPDATE</span> userdatabase u <span class="kw1">SET</span> startdate <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> u.databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, CAST<span class="br0">&#40;</span><span class="kw3">ROUND</span><span class="br0">&#40;</span><span class="kw3">EXTRACT</span><span class="br0">&#40;</span>EPOCH <span class="kw1">FROM</span> DATE<span class="br0">&#40;</span>p_field_value<span class="br0">&#41;</span><span class="br0">&#41;</span>*<span class="nu0">1000</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw5">text</span><span class="br0">&#41;</span>, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'CODE'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">UPDATE</span> userdatabase u <span class="kw1">SET</span> <span class="kw1">name</span> <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> u.databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, p_field_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'COUNTRY'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">RETURN</span> <span class="kw1">false</span>;
		<span class="kw1">WHEN</span> <span class="st0">'END_DATE'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">UPDATE</span> project <span class="kw1">SET</span> end_date <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, CAST<span class="br0">&#40;</span><span class="kw3">ROUND</span><span class="br0">&#40;</span><span class="kw3">EXTRACT</span><span class="br0">&#40;</span>EPOCH <span class="kw1">FROM</span> DATE<span class="br0">&#40;</span>p_field_value<span class="br0">&#41;</span><span class="br0">&#41;</span>*<span class="nu0">1000</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw5">text</span><span class="br0">&#41;</span>, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'MANAGER'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">UPDATE</span> project <span class="kw1">SET</span> id_manager <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">integer</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, p_field_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'ORG_UNIT'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">UPDATE</span> partnerindatabase <span class="kw1">SET</span> partnerid <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">integer</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, p_field_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'TITLE'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">UPDATE</span> userdatabase u <span class="kw1">SET</span> fullname <span class="sy0">=</span> CAST<span class="br0">&#40;</span>p_field_value <span class="kw1">AS</span> <span class="kw5">character</span> varying<span class="br0">&#40;</span><span class="nu0">500</span><span class="br0">&#41;</span><span class="br0">&#41;</span> 
				<span class="kw1">WHERE</span> u.databaseid <span class="sy0">=</span> p_project_id;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type <span class="kw1">as</span> change_type, p_field_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'BUDGET'</span>
			<span class="kw1">THEN</span> <span class="kw1">RETURN</span> <span class="kw1">false</span>;
		<span class="kw1">WHEN</span> <span class="st0">'SPENT'</span>, <span class="st0">'RECEIVED'</span>, <span class="st0">'PLANNED'</span>
			<span class="kw1">THEN</span> 
			<span class="co1">-- Create budget value</span>
			<span class="co1">-- Example : INSERT INTO value (id_value, id_project, action_last_modif, date_last_modif, value, id_flexible_element, id_user_last_modif) VALUES (12783382, 12783370, 'C', '2016-07-22 16:34:05.619', '380%1.23456789E8~382%0.0~383%0.0', 1598, 122);</span>
			<span class="co1">-- INSERT INTO history_token (id_history_token, history_date, id_element, id_project, change_type, value, id_user, comment, core_version) VALUES (12783389, '2016-07-22 16:34:05.629', 1598, 12783370, 'ADD', '380%1.23456789E8~382%0.0~383%0.0', 122, NULL, NULL);</span>
			v_value :<span class="sy0">=</span> get_updated_budget_string<span class="br0">&#40;</span>p_field_id, p_project_id, p_field_value<span class="br0">&#41;</span>;
			IF<span class="br0">&#40;</span> v_action_last_modif <span class="sy0">=</span> <span class="st0">'C'</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				<span class="kw1">INSERT</span> <span class="kw1">INTO</span> value<span class="br0">&#40;</span>
					    id_value, id_project, action_last_modif, date_last_modif, <span class="kw1">value</span>, 
					    id_flexible_element, id_user_last_modif<span class="br0">&#41;</span>
				    <span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, p_project_id, v_action_last_modif, <span class="kw1">localtimestamp</span>, v_value,
						v_budget_field_id, p_author_id;
			<span class="kw1">ELSE</span>
				<span class="kw1">UPDATE</span> <span class="kw1">value</span>  <span class="kw1">SET</span> action_last_modif <span class="sy0">=</span> <span class="st0">'U'</span>, date_last_modif <span class="sy0">=</span> <span class="kw1">localtimestamp</span>,
					<span class="kw1">value</span> <span class="sy0">=</span> v_value, id_user_last_modif <span class="sy0">=</span> p_author_id 
					<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> v_budget_field_id <span class="kw1">and</span> id_project <span class="sy0">=</span> p_project_id;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, v_budget_field_id, p_project_id, 
					v_history_change_type, v_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'OWNER'</span>
			<span class="kw1">THEN</span> 
			<span class="kw1">RETURN</span> <span class="kw1">false</span>;
		<span class="kw1">WHEN</span> <span class="st0">'DATE'</span>
			<span class="kw1">THEN</span> 
			v_value :<span class="sy0">=</span> CAST<span class="br0">&#40;</span><span class="kw3">ROUND</span><span class="br0">&#40;</span><span class="kw3">EXTRACT</span><span class="br0">&#40;</span>EPOCH <span class="kw1">FROM</span> DATE<span class="br0">&#40;</span>p_field_value<span class="br0">&#41;</span><span class="br0">&#41;</span>*<span class="nu0">1000</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw5">text</span><span class="br0">&#41;</span>;
			IF<span class="br0">&#40;</span> v_action_last_modif <span class="sy0">=</span> <span class="st0">'C'</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				<span class="kw1">INSERT</span> <span class="kw1">INTO</span> value<span class="br0">&#40;</span>
					    id_value, id_project, action_last_modif, date_last_modif, <span class="kw1">value</span>, 
					    id_flexible_element, id_user_last_modif<span class="br0">&#41;</span>
				    <span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, p_project_id, v_action_last_modif, <span class="kw1">localtimestamp</span>, v_value,
						p_field_id, p_author_id;
			<span class="kw1">ELSE</span>
				<span class="kw1">UPDATE</span> <span class="kw1">value</span>  <span class="kw1">SET</span> action_last_modif <span class="sy0">=</span> <span class="st0">'U'</span>, date_last_modif <span class="sy0">=</span> <span class="kw1">localtimestamp</span>,
					<span class="kw1">value</span> <span class="sy0">=</span> v_value, id_user_last_modif <span class="sy0">=</span> p_author_id 
					<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> p_field_id <span class="kw1">and</span> id_project <span class="sy0">=</span> p_project_id;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type, v_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">WHEN</span> <span class="st0">'NUMBER'</span>, <span class="st0">'TEXT'</span>, <span class="st0">'PARAGRAPH'</span>
			<span class="kw1">THEN</span> 
			IF<span class="br0">&#40;</span> v_action_last_modif <span class="sy0">=</span> <span class="st0">'C'</span><span class="br0">&#41;</span>
			<span class="kw1">THEN</span>
				<span class="kw1">INSERT</span> <span class="kw1">INTO</span> value<span class="br0">&#40;</span>
					    id_value, id_project, action_last_modif, date_last_modif, <span class="kw1">value</span>, 
					    id_flexible_element, id_user_last_modif<span class="br0">&#41;</span>
				    <span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, p_project_id, v_action_last_modif, <span class="kw1">localtimestamp</span>, p_field_value,
						p_field_id, p_author_id;
			<span class="kw1">ELSE</span>
				<span class="kw1">UPDATE</span> <span class="kw1">value</span>  <span class="kw1">SET</span> action_last_modif <span class="sy0">=</span> <span class="st0">'U'</span>, date_last_modif <span class="sy0">=</span> <span class="kw1">localtimestamp</span>,
					<span class="kw1">value</span> <span class="sy0">=</span> p_field_value, id_user_last_modif <span class="sy0">=</span> p_author_id 
					<span class="kw1">WHERE</span> id_flexible_element <span class="sy0">=</span> p_field_id <span class="kw1">and</span> id_project <span class="sy0">=</span> p_project_id;
			<span class="kw1">END</span> <span class="kw1">IF</span>;
			<span class="kw1">INSERT</span> <span class="kw1">INTO</span> history_token<span class="br0">&#40;</span>id_history_token, history_date, id_element, id_project, 
					change_type, <span class="kw1">value</span>, id_user, <span class="kw1">comment</span>, core_version<span class="br0">&#41;</span> 
				<span class="kw1">SELECT</span> v_id_history_token, v_history_date, p_field_id, p_project_id, 
					v_history_change_type, p_field_value, p_author_id, p_history_comment, p_core_version;
		<span class="kw1">ELSE</span>
			<span class="kw1">return</span> <span class="kw1">false</span>;
	<span class="kw1">END</span> <span class="kw1">CASE</span>;
&nbsp;
	<span class="co1">--Create a new link from an amendment is an amendment id is given from the amendment_history_token table</span>
	<span class="kw1">IF</span> <span class="br0">&#40;</span> p_amendment_history_token <span class="kw1">is</span> <span class="kw1">not</span> <span class="kw1">null</span><span class="br0">&#41;</span>
	<span class="kw1">THEN</span>
		<span class="kw1">INSERT</span> <span class="kw1">INTO</span> amendment_history_token<span class="br0">&#40;</span>amendment_id_amendment, values_id_history_token<span class="br0">&#41;</span> 
		<span class="kw1">VALUES</span> <span class="br0">&#40;</span>p_amendment_history_token, v_id_history_token<span class="br0">&#41;</span>;
	<span class="kw1">END</span> <span class="kw1">IF</span>;
&nbsp;
<span class="kw1">RETURN</span> <span class="kw1">true</span>;
<span class="kw1">END</span>;
$$ <span class="kw1">LANGUAGE</span> plpgsql;
&nbsp;
&nbsp;
<span class="co1">-- Call the budget field migration function</span>
<span class="kw1">START</span> <span class="kw1">transaction</span>;
<span class="kw1">SELECT</span> migrate_budget_fields<span class="br0">&#40;</span><span class="br0">&#41;</span>;
<span class="kw1">DROP</span> <span class="kw1">FUNCTION</span> migrate_budget_fields<span class="br0">&#40;</span><span class="kw5">boolean</span><span class="br0">&#41;</span>;
<span class="kw1">DROP</span> <span class="kw1">FUNCTION</span> get_field_type<span class="br0">&#40;</span><span class="kw5">integer</span><span class="br0">&#41;</span>;
<span class="kw1">DROP</span> <span class="kw1">FUNCTION</span> get_field_type<span class="br0">&#40;</span><span class="kw5">bigint</span><span class="br0">&#41;</span>;
<span class="kw1">DROP</span> <span class="kw1">FUNCTION</span> update_field_anytime<span class="br0">&#40;</span><span class="kw5">integer</span>, <span class="kw5">text</span>, <span class="kw5">integer</span>, <span class="kw5">integer</span>, <span class="kw5">character varying</span>, <span class="kw5">timestamp</span> <span class="kw1">without</span> <span class="kw5">time</span> <span class="kw1">zone</span>, <span class="kw5">integer</span>, <span class="kw5">integer</span><span class="br0">&#41;</span>;
<span class="kw1">COMMIT</span>;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
<span class="co1">-- Project team sub-tab (#620) : gives rights to view/edit all projects to all profiles having right to view/edit projects</span>
<span class="kw1">UPDATE</span> global_permission <span class="kw1">SET</span> permission <span class="sy0">=</span> <span class="st0">'VIEW_MY_PROJECTS'</span> <span class="kw1">WHERE</span> permission <span class="sy0">=</span> <span class="st0">'VIEW_PROJECT'</span>;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> global_permission<span class="br0">&#40;</span>id_global_permission, permission, id_profile<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, <span class="st0">'VIEW_ALL_PROJECTS'</span>, id_profile
<span class="kw1">FROM</span> global_permission
<span class="kw1">WHERE</span> permission <span class="sy0">=</span> <span class="st0">'VIEW_MY_PROJECTS'</span>;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> global_permission<span class="br0">&#40;</span>id_global_permission, permission, id_profile<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, <span class="st0">'EDIT_ALL_PROJECTS'</span>, id_profile
<span class="kw1">FROM</span> global_permission
<span class="kw1">WHERE</span> permission <span class="sy0">=</span> <span class="st0">'EDIT_PROJECT'</span>;
&nbsp;
<span class="co1">-- User attached to several OrgUnit (#243)</span>
<span class="kw1">UPDATE</span> user_unit <span class="kw1">SET</span> user_unit_type <span class="sy0">=</span> <span class="st0">'MAIN'</span>;
&nbsp;
<span class="co1">-- Contact database (aka &quot;CRM&quot;) (#634)</span>
<span class="kw1">SELECT</span>
  contact_model_create<span class="br0">&#40;</span>o.id_organization, <span class="st0">'ORGANIZATION'</span>, o.<span class="kw1">name</span> <span class="sy0">||</span> <span class="st0">' model'</span><span class="br0">&#41;</span>,
  contact_model_create<span class="br0">&#40;</span>o.id_organization, <span class="st0">'INDIVIDUAL'</span>, <span class="st0">'Sigmah user model'</span><span class="br0">&#41;</span>
<span class="kw1">FROM</span> organization o;
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> contact <span class="br0">&#40;</span>id_contact, id_contact_model, id_organization, date_created<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, cm.id_contact_model, o.id_organization, <span class="kw3">NOW</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">FROM</span> organization o
<span class="kw1">JOIN</span> contact_model cm <span class="kw1">ON</span> <span class="br0">&#40;</span>cm.id_organization <span class="sy0">=</span> o.id_organization <span class="kw1">AND</span> cm.<span class="kw1">name</span> <span class="sy0">=</span> o.<span class="kw1">name</span> <span class="sy0">||</span> <span class="st0">' model'</span><span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> contact <span class="br0">&#40;</span>id_contact, id_contact_model, id_user, id_parent, date_created<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw3">nextval</span><span class="br0">&#40;</span><span class="st0">'hibernate_sequence'</span><span class="br0">&#41;</span>, cm.id_contact_model, u.userid, parent.id_contact, <span class="kw3">NOW</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">FROM</span> userlogin u
<span class="kw1">JOIN</span> contact_model cm <span class="kw1">ON</span> <span class="br0">&#40;</span>cm.id_organization <span class="sy0">=</span> u.id_organization <span class="kw1">AND</span> cm.<span class="kw1">name</span> <span class="sy0">=</span> <span class="st0">'Sigmah user model'</span><span class="br0">&#41;</span>
<span class="kw1">JOIN</span> contact parent <span class="kw1">ON</span> <span class="br0">&#40;</span>parent.id_organization <span class="sy0">=</span> u.id_organization<span class="br0">&#41;</span>;</pre>
</dd></dl>

</div>

<h1 class="sectionedit7" id="release_21">Release 2.1</h1>
<div class="level1">

</div>

<h2 class="sectionedit8" id="schema_changes2">1. Schema changes</h2>
<div class="level2">
<dl class="code">
<dt><a href="sigmah-schemachanges-v2.1bafb.sql?do=export_code&amp;id=contributorguide:schemachangelog&amp;codeblock=3" title="Download Snippet" class="mediafile mf_sql">sigmah-schemachanges-v2.1.sql</a></dt>
<dd><pre class="code postgresql"><span class="co1">-- &quot;code&quot; property.</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> flexible_element <span class="kw1">ADD</span> code VARCHAR<span class="br0">&#40;</span><span class="nu0">30</span><span class="br0">&#41;</span>;
&nbsp;
<span class="co1">-- &quot;computation field&quot; flexible element.</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> computation_element
<span class="br0">&#40;</span>
  id_flexible_element <span class="kw5">int</span> <span class="kw1">primary</span> <span class="kw1">key</span>,
  <span class="kw1">rule</span> varchar<span class="br0">&#40;</span><span class="nu0">1500</span><span class="br0">&#41;</span>,
  minimum varchar<span class="br0">&#40;</span><span class="nu0">1500</span><span class="br0">&#41;</span>,
  maximum varchar<span class="br0">&#40;</span><span class="nu0">1500</span><span class="br0">&#41;</span>
<span class="br0">&#41;</span>;</pre>
</dd></dl>

</div>

<h2 class="sectionedit9" id="existing_data_updates1">2. Existing data updates</h2>
<div class="level2">
<dl class="code">
<dt><a href="sigmah-dataupdates-v2.16149.sql?do=export_code&amp;id=contributorguide:schemachangelog&amp;codeblock=4" title="Download Snippet" class="mediafile mf_sql">sigmah-dataupdates-v2.1.sql</a></dt>
<dd><pre class="code postgresql"><span class="co1">-- Add default field codes to numeric fields which haven't any</span>
<span class="kw1">UPDATE</span> flexible_element
<span class="kw1">SET</span> code <span class="sy0">=</span> <span class="st0">'f'</span> <span class="sy0">||</span> id_flexible_element 
<span class="kw1">WHERE</span> id_flexible_element <span class="kw1">in</span>
	<span class="br0">&#40;</span><span class="kw1">SELECT</span> fe.id_flexible_element 
	<span class="kw1">FROM</span> flexible_element fe
		<span class="kw1">inner</span> <span class="kw1">join</span> textarea_element te <span class="kw1">on</span> te.id_flexible_element <span class="sy0">=</span> fe.id_flexible_element
	<span class="kw1">WHERE</span> fe.code <span class="kw1">is</span> <span class="kw1">null</span> <span class="kw1">and</span> te.<span class="kw1">type</span> <span class="sy0">=</span> <span class="st0">'N'</span><span class="br0">&#41;</span>;</pre>
</dd></dl>

</div>

<h1 class="sectionedit10" id="release_20">Release 2.0</h1>
<div class="level1">

</div>

<h2 class="sectionedit11" id="schema_changes3">1. Schema changes</h2>
<div class="level2">
<pre class="code">
-- Add table for storing the password expiration policy of an organization (issue #438 / #517)
-- ------
CREATE TABLE password_expiration_policy
(
  id bigint NOT NULL,
  policy_type character varying(255),
  reference_date date,
  frequency integer,
  reset_for_new_users boolean NOT NULL,
  organization_id integer NOT NULL,
  CONSTRAINT password_expiration_policy_pkey PRIMARY KEY (id),
  CONSTRAINT fk2fb477b2f85c2c3c FOREIGN KEY (organization_id)
      REFERENCES organization (id_organization) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
)
WITH (
  OIDS=FALSE
);

-- Default password expiration policy (with no automatic reset set)
INSERT INTO password_expiration_policy (id, policy_type, reset_for_new_users, organization_id) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;NEVER&#039;, false, MAX(id_organization) FROM organization;



-- Add column to store the last password change of an user. (issue #438 / #517)
-- ------
ALTER TABLE UserLogin ADD COLUMN last_password_change timestamp without time zone;



-- Add columns to store the start date of maintenance periods. (issue #419)
-- ------
ALTER TABLE flexible_element ADD COLUMN creation_date timestamp without time zone not null default current_timestamp;

ALTER TABLE project_model ADD COLUMN date_maintenance timestamp without time zone;
ALTER TABLE org_unit_model ADD COLUMN date_maintenance timestamp without time zone;

ALTER TABLE flexible_element ADD COLUMN is_disabled boolean default false;
ALTER TABLE question_choice_element ADD COLUMN is_disabled boolean default false;


-- Adds tables for managing reminders and monitored points history  (issue #550)
-- ------
CREATE TABLE reminder_history (
	id_reminder_history integer PRIMARY KEY,
	generated_date timestamp without time zone NOT NULL,
	id_reminder integer REFERENCES reminder NOT NULL,
	id_user integer NOT NULL,
	value text,
	change_type character varying(255) NOT NULL
);

CREATE TABLE monitored_point_history (
	id_monitored_point_history integer PRIMARY KEY,
	generated_date timestamp without time zone NOT NULL,
	id_monitored_point integer REFERENCES monitored_point NOT NULL,
	id_user integer NOT NULL,
	value text,
	change_type character varying(255) NOT NULL
);


-- Adds tables for managing the flexibility of budget element and sets by default the planned and spent budget  (issue #386)
-- ------

CREATE TABLE budget_element
(
  id_flexible_element bigint NOT NULL,
  id_ratio_divisor bigint,
  id_ratio_dividend bigint,
  CONSTRAINT budget_element_pkey PRIMARY KEY (id_flexible_element),
  CONSTRAINT fk1ba06002a82c370 FOREIGN KEY (id_flexible_element)
      REFERENCES default_flexible_element (id_flexible_element) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE budget_sub_field
(
  id_budget_sub_field bigint NOT NULL,
  label character varying(255),
  id_budget_element bigint NOT NULL,
  fieldorder integer,
  type character varying(255),
  CONSTRAINT budget_sub_field_pkey PRIMARY KEY (id_budget_sub_field),
  CONSTRAINT fkc12629c1a251b09 FOREIGN KEY (id_budget_element)
      REFERENCES budget_element (id_flexible_element) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

ALTER TABLE budget_element ADD  CONSTRAINT fk1ba0600222f4f59 FOREIGN KEY (id_ratio_divisor)
      REFERENCES budget_sub_field (id_budget_sub_field) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION;
	  
ALTER TABLE budget_element ADD  CONSTRAINT fk1ba06002a2a3285a FOREIGN KEY (id_ratio_dividend)
      REFERENCES budget_sub_field (id_budget_sub_field) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION;
	  

INSERT INTO budget_element (id_flexible_element)
	SELECT id_flexible_element FROM default_flexible_element WHERE default_flexible_element.type = &#039;BUDGET&#039; AND default_flexible_element.id_flexible_element NOT IN (SELECT budget_element.id_flexible_element FROM budget_element );
INSERT INTO budget_sub_field (id_budget_sub_field,label, id_budget_element, fieldorder, type) 
			SELECT nextval(&#039;hibernate_sequence&#039;), NULL, budget_element.id_flexible_element, 0, &#039;RECEIVED&#039; FROM  budget_element;
INSERT INTO budget_sub_field (id_budget_sub_field,label, id_budget_element, fieldorder, type) 
			SELECT nextval(&#039;hibernate_sequence&#039;), NULL, budget_element.id_flexible_element, 0, &#039;SPENT&#039; FROM  budget_element;
INSERT INTO budget_sub_field (id_budget_sub_field,label, id_budget_element, fieldorder, type) 
			SELECT nextval(&#039;hibernate_sequence&#039;), NULL, budget_element.id_flexible_element, 0, &#039;PLANNED&#039; FROM  budget_element;
	UPDATE budget_element  SET id_ratio_divisor = bsf.id_budget_sub_field FROM budget_sub_field bsf WHERE  id_flexible_element =  bsf.id_budget_element AND bsf.type = &#039;PLANNED&#039;;
	UPDATE budget_element  SET id_ratio_dividend = bsf.id_budget_sub_field FROM budget_sub_field bsf WHERE  id_flexible_element =  bsf.id_budget_element AND bsf.type = &#039;SPENT&#039;;


-- Deletes all entries from the AdminEntity table which contains only admin entities from the Democratic Republic of the Congo 
-- ------

DELETE FROM adminentity;


-- Set all users as active by default (issue #771)
-- ------
ALTER TABLE UserLogin ALTER COLUMN active SET default true;



-- Add column for the main site
-- ------
ALTER TABLE project ADD COLUMN mainsite int;

-- 
-- Add column for comment in the history token table.
-- ------
ALTER TABLE history_token ADD comment varchar(255);



-- Add tables to manage importation scheme (importation frameworks)
-- ------

CREATE TABLE importation_scheme
(
  sch_id bigint NOT NULL,
  datedeleted timestamp without time zone,
  sch_file_format character varying(255) NOT NULL,
  sch_first_row integer,
  sch_import_type character varying(255) NOT NULL,
  sch_name character varying(255) NOT NULL,
  sch_sheet_name character varying(255),
  CONSTRAINT importation_scheme_pkey PRIMARY KEY (sch_id )
);


CREATE TABLE importation_scheme_model
(
  sch_mod_id bigint NOT NULL,
  datedeleted timestamp without time zone,
  sch_id bigint NOT NULL,
  org_unit_model_id integer,
  id_project_model bigint,
  CONSTRAINT importation_scheme_model_pkey PRIMARY KEY (sch_mod_id ),
  CONSTRAINT fk_cgrmoq07kxyggtnldsvlwjqcs FOREIGN KEY (id_project_model)
      REFERENCES project_model (id_project_model) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_ckwexvghil94ha4ct8b1wepxq FOREIGN KEY (org_unit_model_id)
      REFERENCES org_unit_model (org_unit_model_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_prpi3dmykj4nbdeyk3dhb51jn FOREIGN KEY (sch_id)
      REFERENCES importation_scheme (sch_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE importation_scheme_variable
(
  var_id bigint NOT NULL,
  datedeleted timestamp without time zone,
  var_name character varying(255) NOT NULL,
  var_reference character varying(255) NOT NULL,
  sch_id bigint NOT NULL,
  CONSTRAINT importation_scheme_variable_pkey PRIMARY KEY (var_id ),
  CONSTRAINT fk_khgoedwqkg3au5a2o3fe4g398 FOREIGN KEY (sch_id)
      REFERENCES importation_scheme (sch_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);


CREATE TABLE importation_scheme_variable_flexible_element
(
  var_fle_id bigint NOT NULL,
  datedeleted timestamp without time zone,
  var_fle_is_key boolean,
  id_flexible_element bigint NOT NULL,
  sch_mod_id bigint NOT NULL,
  var_id bigint,
  CONSTRAINT importation_scheme_variable_flexible_element_pkey PRIMARY KEY (var_fle_id ),
  CONSTRAINT fk_kr8tjw9mvseef9x0il6dojoh9 FOREIGN KEY (sch_mod_id)
      REFERENCES importation_scheme_model (sch_mod_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_nbgxlc3whl76ws07c99f70r6n FOREIGN KEY (var_id)
      REFERENCES importation_scheme_variable (var_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_q4la1it8wgg6nkosxi6rpd4cp FOREIGN KEY (id_flexible_element)
      REFERENCES flexible_element (id_flexible_element) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE importation_scheme_variable_budget_element
(
  var_fle_id bigint NOT NULL,
  CONSTRAINT importation_scheme_variable_budget_element_pkey PRIMARY KEY (var_fle_id ),
  CONSTRAINT fk_eu352p1mmft8pwwyylmwe63q8 FOREIGN KEY (var_fle_id)
      REFERENCES importation_scheme_variable_flexible_element (var_fle_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE importation_variable_budget_sub_field
(
  id_budget_sub_field bigint NOT NULL,
  var_id bigint NOT NULL,
  var_fle_id bigint NOT NULL,
  CONSTRAINT importation_variable_budget_sub_field_pkey PRIMARY KEY (id_budget_sub_field , var_id , var_fle_id ),
  CONSTRAINT fk_dfeq1vnw6d3ooeqf1stt4x276 FOREIGN KEY (var_id)
      REFERENCES importation_scheme_variable (var_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_ms0uq981iysge90gt1o3pf40q FOREIGN KEY (var_fle_id)
      REFERENCES importation_scheme_variable_budget_element (var_fle_id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_og2mv36vlu4uu885yrpnhbl2q FOREIGN KEY (id_budget_sub_field)
      REFERENCES budget_sub_field (id_budget_sub_field) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);


-- Core version element table
-- -----

CREATE TABLE core_version_element
(
  id_flexible_element int primary key
);


-- Add column name in amendement (project core)
-- --------------------------------------------
ALTER TABLE amendment ADD COLUMN name character varying(255);



-- Add column for the core version
-- --------------------------------
ALTER TABLE history_token ADD core_version int;



-- Add column for disabling flexible elements
-- ------
ALTER TABLE flexible_element ADD disabled_date timestamp;
</pre>

</div>

<h2 class="sectionedit12" id="existing_data_updates2">2. Existing data updates</h2>
<div class="level2">

<p>
<strong>After the schema is updated</strong>, in order to update the existing data, the following request has to be applied (request required because of the issue <a href="http://www.sigmah.org/issues/view.php?id=386" class="urlextern" title="http://www.sigmah.org/issues/view.php?id=386" rel="nofollow">0000386: Flexible budget field</a> which lets user modify the budget sub fields)
</p>
<pre class="code">
-- Add South Sudan newest country in Sigmah list of countries
INSERT INTO Country (CountryId, x1, x2, y1, y2, ISO2, Name) VALUES (495, -180, 180, -90, 180, &#039;SS&#039;, &#039;South Sudan&#039;);

-- Updates all project model existing default fields to set them as part of project core (issue #167) (but not orgunit default fields)
update flexible_element
set amendable = TRUE
where id_flexible_element in 
	(select dfe.id_flexible_element 
	from default_flexible_element dfe
	where dfe.id_flexible_element not in 
		(select id_flexible_element 
		from layout_constraint lc
			inner join layout_group lg on lg.id_layout_group = lc.id_layout_group
			inner join org_unit_details oud on oud.id_layout = lg.id_layout)
	);


-- Updates existing users &#039;last password change&#039; with current timestamp (issue #438 / #517)
-- ------
UPDATE UserLogin SET last_password_change = current_timestamp;



-- Updates existing global permissions to the new hierarchy of privileges (issue #616 and related)
-- ------
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;CREATE_TEST_PROJECT&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;REMOVE_PROJECT_FILE&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;REMOVE_FILE&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;REMOVE_ORG_UNIT_FILE&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;REMOVE_FILE&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;LOCK_PROJECT&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;VIEW_PROJECT_AGENDA&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_PROJECT_AGENDA&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;

INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;VIEW_LOGFRAME&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_LOGFRAME&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;VIEW_INDICATOR&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;VIEW_MAPTAB&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_MAIN_SITE&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_SITES&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_INDICATOR&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_INDICATOR&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;

INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_OWN_REMINDERS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_ALL_REMINDERS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;

INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;RELATE_PROJECT&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;EDIT_PROJECT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_ORG_UNIT&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;MANAGE_UNIT&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;REMOVE_ORG_UNIT_FILE&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;REMOVE_FILE&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;VIEW_ORG_UNIT_AGENDA&#039;, p.id_profile FROM profile p WHERE p.id_profile not in (select id_profile from global_permission where permission=&#039;VIEW_ORG_UNIT_AGENDA&#039;);
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;EDIT_ORG_UNIT_AGENDA&#039;, p.id_profile FROM profile p WHERE p.id_profile not in (select id_profile from global_permission where permission=&#039;EDIT_ORG_UNIT_AGENDA&#039;);
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_USERS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_ORG_UNITS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_PROJECT_MODELS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_ORG_UNIT_MODELS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_REPORT_MODELS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_CATEGORIES&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_IMPORTATION_SCHEMES&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;MANAGE_SETTINGS&#039;, p.id_profile FROM global_permission p WHERE p.permission=&#039;VIEW_ADMIN&#039;;

INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;CHANGE_PASSWORD&#039;, p.id_profile FROM profile p WHERE p.id_profile not in (select id_profile from global_permission where permission=&#039;CHANGE_PASSWORD&#039;);
DELETE FROM global_permission p WHERE p.permission=&#039;MANAGE_UNIT&#039;;
DELETE FROM global_permission p WHERE p.permission=&#039;REMOVE_FILE&#039;;
DELETE FROM global_permission p WHERE p.permission=&#039;MANAGE_USER&#039;;
DELETE FROM global_permission p WHERE p.permission=&#039;VIEW_AGENDA&#039;;
DELETE FROM global_permission p WHERE p.permission=&#039;EDIT_AGENDA&#039;;

-- Updates history_token and value to table to fit the new structure of a budget element (issue #386)
-- ------
UPDATE history_token SET value = planned_budget_id || &#039;%&#039; || coalesce(budgetValues[1], &#039;0.0&#039;) || &#039;~&#039; || received_budget_id || &#039;%&#039; || coalesce(budgetValues[2], &#039;0.0&#039;)  || &#039;~&#039; || spent_budget_id || &#039;%&#039; ||  coalesce(budgetValues[3], &#039;0.0&#039;) 
FROM (
	SELECT value, string_to_array(value, &#039;~&#039;) AS budgetValues, flexible_element.id_flexible_element, id_history_token,
		planned.id_budget_sub_field  AS planned_budget_id,
		spent.id_budget_sub_field    AS spent_budget_id,
		received.id_budget_sub_field AS received_budget_id
	FROM history_token AS ht
	INNER JOIN flexible_element ON ( flexible_element.id_flexible_element = ht.id_element )
	LEFT  JOIN budget_sub_field AS planned  ON ( planned.id_budget_element = flexible_element.id_flexible_element  AND planned.type = &#039;PLANNED&#039; )
	LEFT  JOIN budget_sub_field AS spent    ON ( spent.id_budget_element = flexible_element.id_flexible_element    AND spent.type = &#039;SPENT&#039; )
	LEFT  JOIN budget_sub_field AS received ON ( received.id_budget_element = flexible_element.id_flexible_element AND received.type = &#039;RECEIVED&#039; )
	WHERE flexible_element.id_flexible_element IN (Select id_flexible_element from budget_element)
) AS ssrequete
WHERE history_token.id_history_token = ssrequete.id_history_token;


INSERT INTO value (id_value, id_project, action_last_modif, date_last_modif, value, id_flexible_element, id_user_last_modif)
SELECT nextval(&#039;hibernate_sequence&#039;), ht.id_project, CASE change_type WHEN &#039;EDIT&#039; THEN &#039;U&#039; ELSE &#039;C&#039; END, history_date, value, ht.id_element, id_user
FROM history_token AS ht JOIN ( SELECT history_token.id_project, history_token.id_element, MAX (id_history_token) AS max_history_id FROM history_token GROUP BY id_project, id_element) AS requete
  ON requete.id_project = ht.id_project AND requete.id_element = ht.id_element AND requete.max_history_id = ht.id_history_token
WHERE (ht.id_project, ht.id_element) NOT IN (SELECT id_project, id_flexible_element FROM value) AND ht.id_element IN (SELECT id_flexible_element FROM budget_element);



-- Set all users as active by default (issue #771)
-- ------
UPDATE UserLogin SET active = true WHERE active is null;




</pre>

</div>

<h1 class="sectionedit13" id="release_12">Release 1.2</h1>
<div class="level1">

</div>

<h2 class="sectionedit14" id="schema_changes4">1. Schema changes</h2>
<div class="level2">
<pre class="code">

-- Add the exportable preferences columns to the fields table and the required new tables (issue #388)
-- ------

-- POSTGRESQL
ALTER TABLE flexible_element ADD COLUMN exportable BOOLEAN NOT NULL DEFAULT TRUE;
ALTER TABLE flexible_element ADD COLUMN globally_exportable BOOLEAN NOT NULL DEFAULT TRUE;


-- MYSQL
ALTER TABLE flexible_element ADD exportable bit(1) NOT NULL DEFAULT b&#039;1&#039;;
ALTER TABLE flexible_element ADD globally_exportable bit(1) NOT NULL DEFAULT b&#039;1&#039;;


-- Add tables and basic default settings for Global Export (issue #388)
-- ------

-- tables in POSTGRESQL
CREATE TABLE global_export (
    id bigint NOT NULL,
    generated_date timestamp without time zone NOT NULL,
    organization_id integer NOT NULL
);

CREATE TABLE global_export_content (
    id bigint NOT NULL,
    csv_content text,
    project_model_name character varying(8192) NOT NULL,
    global_export_id bigint NOT NULL
);

CREATE TABLE global_export_settings (
    id bigint NOT NULL,
    auto_delete_frequency integer,
    auto_export_frequency integer,
    default_organization_export_format character varying(255),
    export_format character varying(255),
    last_export_date timestamp without time zone,
    locale_string character varying(4) NOT NULL,
    organization_id integer NOT NULL
);

ALTER TABLE ONLY global_export_content
    ADD CONSTRAINT global_export_content_pkey PRIMARY KEY (id);

ALTER TABLE ONLY global_export
    ADD CONSTRAINT global_export_pkey PRIMARY KEY (id);

ALTER TABLE ONLY global_export_settings
    ADD CONSTRAINT global_export_settings_pkey PRIMARY KEY (id);

ALTER TABLE ONLY global_export_settings
    ADD CONSTRAINT fk2fb477b2f85c2c3c FOREIGN KEY (organization_id) REFERENCES organization(id_organization);

ALTER TABLE ONLY global_export
    ADD CONSTRAINT fk9e763fd0f85c2c3c FOREIGN KEY (organization_id) REFERENCES organization(id_organization);

ALTER TABLE ONLY global_export_content
    ADD CONSTRAINT fkdca84b0af33647b9 FOREIGN KEY (global_export_id) REFERENCES global_export(id);




-- POSTGRESQL
INSERT INTO global_export_settings(id, auto_delete_frequency, auto_export_frequency, default_organization_export_format, export_format, last_export_date, locale_string, organization_id)
SELECT nextval(&#039;hibernate_sequence&#039;), NULL, NULL, &#039;XLS&#039;, &#039;XLS&#039;, NULL, &#039;fr&#039;, id_organization FROM organization;

-- MYSQL
INSERT INTO global_export_settings(auto_delete_frequency, auto_export_frequency, default_organization_export_format, export_format, last_export_date, locale_string, organization_id)
SELECT NULL, NULL, &#039;XLS&#039;, &#039;XLS&#039;, NULL, &#039;fr&#039;, id_organization FROM organization;

-- Changes the date type columns to timestamp to avoid time difference (issue #463)
-- ------

-- POSTGRESQL
ALTER TABLE userdatabase ALTER COLUMN startdate TYPE TIMESTAMP;
ALTER TABLE project ALTER COLUMN end_date TYPE TIMESTAMP;
ALTER TABLE project ALTER COLUMN close_date TYPE TIMESTAMP;

ALTER TABLE personalevent ALTER COLUMN enddate TYPE TIMESTAMP WITH TIME ZONE;
ALTER TABLE personalevent ALTER COLUMN startdate TYPE TIMESTAMP WITH TIME ZONE;

-- MYSQL
ALTER TABLE userdatabase CHANGE startdate startdate TIMESTAMP;
ALTER TABLE project CHANGE end_date end_date TIMESTAMP;
ALTER TABLE project CHANGE close_date close_date TIMESTAMP;

-- Increases the indicator name length (issue #408).
-- ------
ALTER TABLE indicator ALTER COLUMN name TYPE varchar(1024);


-- Increases the indicator category length (issue #434).
-- ------
ALTER TABLE indicator ALTER COLUMN category TYPE varchar(1024);


-- Merges &#039;risks&#039; and &#039;hypothesis&#039; columns of the log frame (issue #189).
-- ------

-- POSTGRESQL
ALTER TABLE log_frame_element ADD COLUMN risksAndAssumptions TEXT;

-- MYSQL
ALTER TABLE log_frame_element ADD risksAndAssumptions TEXT;


-- MYSQL AND POSTGRESQL
UPDATE log_frame_element SET risksAndAssumptions=( risks  || &#039;\n&#039; || assumptions) WHERE char_length(assumptions)&gt;0 and char_length(risks)&gt;0;
UPDATE log_frame_element SET risksAndAssumptions=risks WHERE (char_length(assumptions)=0 or assumptions is null)  and char_length(risks)&gt;0;  
UPDATE log_frame_element SET risksAndAssumptions=assumptions WHERE (char_length(risks)=0 or risks is null)  and char_length(assumptions)&gt;0;   
ALTER TABLE log_frame_element DROP risks;
ALTER TABLE log_frame_element DROP assumptions;

-- Add a date_deleted column to the table project_model and org_unit_model (issue #489)
-- ------

-- POSTGRESQL
ALTER TABLE org_unit_model ADD COLUMN date_deleted DATE;
ALTER TABLE project_model ADD COLUMN date_deleted DATE;

-- MYSQL
ALTER TABLE org_unit_model ADD COLUMN date_deleted DATETIME;
ALTER TABLE project_model ADD COLUMN date_deleted DATETIME;

-- Increases the project code length (issue #504).
-- ------

-- POSTGRESQL
ALTER TABLE userdatabase ALTER COLUMN name TYPE varchar(50);

-- MYSQL
ALTER TABLE userdatabase CHANGE name name varchar(50);
</pre>

</div>

<h2 class="sectionedit15" id="existing_data_updates3">2. Existing data updates</h2>
<div class="level2">
<pre class="code">

-- Updates the countries ISO codes (issue #457)
UPDATE Country SET ISO2 = &#039;BN&#039; WHERE CountryId = 281;
UPDATE Country SET ISO2 = &#039;CN&#039; WHERE CountryId = 293;
UPDATE Country SET ISO2 = &#039;GN&#039; WHERE CountryId = 339;
UPDATE Country SET ISO2 = &#039;HN&#039; WHERE CountryId = 345;
UPDATE Country SET ISO2 = &#039;IN&#039; WHERE CountryId = 349;
UPDATE Country SET ISO2 = &#039;MN&#039; WHERE CountryId = 394;
UPDATE Country SET ISO2 = &#039;AN&#039; WHERE CountryId = 404;
UPDATE Country SET ISO2 = &#039;PN&#039; WHERE CountryId = 423;
UPDATE Country SET ISO2 = &#039;KN&#039; WHERE CountryId = 434;
UPDATE Country SET ISO2 = &#039;SN&#039; WHERE CountryId = 443;
UPDATE Country SET ISO2 = &#039;TN&#039; WHERE CountryId = 472;
UPDATE Country SET ISO2 = &#039;VN&#039; WHERE CountryId = 487;


-- Fixes issue with old inconsistent data in the log_frame_model table (issue #189)
UPDATE log_frame_model SET a_gp_max=1, a_max=1, a_per_er_max=1, a_per_gp_max=1, a_enable_groups=false, er_enable_groups=false, p_enable_groups=false, so_enable_groups=false, er_gp_max=1, er_max=1, er_per_gp_max=1, er_per_so_max=1, p_gp_max=1, p_max=1, p_per_gp_max=1, so_gp_max=1, so_max=1, so_per_gp_max=1 
WHERE name LIKE &#039;Auto-created default model at%&#039;;

-- Removes temporarily ACTIVITY INFO permission (issue #591)
DELETE FROM global_permission WHERE permission = &#039;VIEW_ACTIVITYINFO&#039;;

-- Deletes the projects links linked to a deleted project (issue #565)
DELETE FROM project_funding AS pf
	USING userdatabase AS ud
	WHERE ud.databaseid = pf.id_project_funded 
		AND ud.datedeleted is not null;
		
DELETE FROM project_funding AS pf
	USING userdatabase AS ud
	WHERE ud.databaseid = pf.id_project_funding
		AND ud.datedeleted is not null;</pre>

</div>

<h1 class="sectionedit16" id="release_11">Release 1.1</h1>
<div class="level1">

</div>

<h2 class="sectionedit17" id="schema_changes5">1. Schema changes</h2>
<div class="level2">
<pre class="code">

ALTER TABLE project DROP COLUMN starred ;  

CREATE TABLE project_userlogin
(
  project_databaseid integer NOT NULL,
  favoriteusers_userid integer NOT NULL,
  CONSTRAINT project_userlogin_pkey PRIMARY KEY (project_databaseid,    favoriteusers_userid),
  CONSTRAINT fk8076a4d884058733 FOREIGN KEY (project_databaseid)
      REFERENCES project (databaseid) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk8076a4d8efbea106 FOREIGN KEY (favoriteusers_userid)
      REFERENCES userlogin (userid) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

ALTER TABLE indicator ADD COLUMN directdataentryenabled boolean;
ALTER TABLE indicator ALTER COLUMN directdataentryenabled SET NOT NULL;
ALTER TABLE indicator ALTER COLUMN directdataentryenabled SET DEFAULT true;
</pre>

</div>

<h2 class="sectionedit18" id="existing_data_updates4">2. Existing data updates</h2>
<div class="level2">

<p>
<strong>After the schema is updated</strong>, in order to update the existing data, the following request has to be applied (request required because of the issue <a href="http://www.sigmah.org/issues/view.php?id=352" class="urlextern" title="http://www.sigmah.org/issues/view.php?id=352" rel="nofollow">000352: OrgUnit administration lacking orgunit model status management</a> which lets user create orgunit from deletable draft orgunit models)
</p>
<pre class="code">
UPDATE org_unit_model
SET status = &#039;USED&#039;
WHERE status=&#039;DRAFT&#039; and org_unit_model_id in (select id_org_unit_model from partner where 1);</pre>

</div>

<h1 class="sectionedit19" id="release_10-rc2">Release 1.0-rc2</h1>
<div class="level1">

</div>

<h2 class="sectionedit20" id="schema_changes6">1. Schema changes</h2>
<div class="level2">
<pre class="code">

ALTER TABLE userdatabase ALTER COLUMN FullName TYPE VARCHAR(500);

ALTER TABLE org_unit_model DROP COLUMN min_level;

ALTER TABLE org_unit_model DROP COLUMN max_level;
</pre>

</div>

<h1 class="sectionedit21" id="release_10">Release 1.0</h1>
<div class="level1">

</div>

<h2 class="sectionedit22" id="schema_changes7">1. Schema changes</h2>
<div class="level2">
<pre class="code">

ALTER TABLE partner ADD COLUMN deleted timestamp without time zone;
</pre>

<p>
<em>For MySQL databases, use instead:</em>
ALTER TABLE partner ADD COLUMN deleted DATETIME DEFAULT NULL;
</p>
<pre class="code">
CREATE TABLE  indicator_datasource (
  IndicatorId int(11) NOT NULL,
  IndicatorSourceId int(11) NOT NULL,
  PRIMARY KEY (IndicatorId,IndicatorSourceId),
  KEY `FK7A87F87547C62157` (indicatorid),
  KEY `FK7A87F8755038B772` (indicatorsourceid)
);
</pre>

<p>
Note: all existing logframe elements will be lost. I&#039;m not aware of any real logframes in the wild yet, but if there are they will have to be migrated by hand to redo the ids.
</p>
<pre class="code">

DROP TABLE log_frame_expected_result;
DROP TABLE log_frame_specific_objective;
DROP TABLE log_frame_activity;

CREATE TABLE  log_frame_element (
  id_element int(11) NOT NULL AUTO_INCREMENT,
  assumptions text,
  code int(11) NOT NULL,
  position int(11) DEFAULT NULL,
  risks text,
  id_group int(11) DEFAULT NULL,
  PRIMARY KEY (`id_element`),
  KEY `FK5A2E206F4F6005EE` (id_group)
);

CREATE TABLE  log_frame_specific_objective (
  `intervention_logic` text,
  `id_element` int(11) NOT NULL,
  `id_log_frame` int(11) NOT NULL,
  PRIMARY KEY (`id_element`),
  KEY `FKC979EF199BC5C4DA` (`id_log_frame`),
  KEY `FKC979EF19E41DAE8` (`id_element`)
);

CREATE TABLE  log_frame_expected_result (
  `intervention_logic` text,
  `id_element` int(11) NOT NULL,
  `id_specific_objective` int(11) NOT NULL,
  PRIMARY KEY (`id_element`),
  KEY `FK99D3DDF7D88379D4` (`id_specific_objective`),
  KEY `FK99D3DDF7E41DAE8` (`id_element`)
);

CREATE TABLE log_frame_activity (
  advancement int(11) DEFAULT NULL,
  endDate datetime DEFAULT NULL,
  startDate datetime DEFAULT NULL,
  title text,
  id_element int(11) NOT NULL,
  id_result int(11) NOT NULL,
  PRIMARY KEY (`id_element`),
  KEY `FK89611FFC8012BC39` (`id_result`),
  KEY `FK89611FFCE41DAE8` (`id_element`)
);

CREATE TABLE  log_frame_indicators (
  `log_frame_element_id_element` int(11) NOT NULL,
  `indicators_IndicatorId` int(11) NOT NULL,
  PRIMARY KEY (`log_frame_element_id_element`,`indicators_IndicatorId`),
  KEY `FK17E5A9F1F6E4C4B8` (`log_frame_element_id_element`),
  KEY `FK17E5A9F1A023DDC` (`indicators_IndicatorId`)
);
</pre>

</div>

<h1 class="sectionedit23" id="release_091">Release 0.9.1</h1>
<div class="level1">

</div>

<h2 class="sectionedit24" id="schema_changes8">1. Schema changes</h2>
<div class="level2">

<p>
From 0.9 to 0.9.1, the following changes have to be performed on the schema:
</p>
<pre class="code">

ALTER TABLE log_frame DROP COLUMN title;

ALTER TABLE project ADD COLUMN activity_advancement INTEGER ;

ALTER TABLE log_frame_activity ADD COLUMN advancement INTEGER ;

ALTER TABLE projectreport ADD COLUMN orgunit_partnerid INTEGER ;

ALTER TABLE category_type ADD COLUMN id_organization INTEGER ;

ALTER TABLE category_element ADD COLUMN id_organization INTEGER ;

ALTER TABLE quality_framework ADD COLUMN id_organization INTEGER ;

ALTER TABLE quality_criterion ADD COLUMN id_organization INTEGER ;

ALTER TABLE privacy_group ADD COLUMN id_organization INTEGER ;

ALTER TABLE profile ADD COLUMN id_organization INTEGER ;

ALTER TABLE projectreportmodel ADD COLUMN id_organization INTEGER ;

ALTER TABLE org_unit_model ADD COLUMN id_organization INTEGER ;

ALTER TABLE monitored_point ADD COLUMN deleted BIT(1);

ALTER TABLE reminder ADD COLUMN deleted BIT(1);
</pre>

</div>

<h2 class="sectionedit25" id="existing_data_updates5">2. Existing data updates</h2>
<div class="level2">

<p>
<strong>After the schema is updated</strong>, in order to update the existing data, the following requests have to be applied: (requests only valid for database with a single organization)
</p>
<pre class="code">

UPDATE category_type SET id_organization = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL) ;

UPDATE category_element SET id_organization = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE quality_framework SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE quality_criterion SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE privacy_group SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE profile SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE projectreportmodel SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);

UPDATE org_unit_model SET id_organization  = (SELECT MAX(id_organization) FROM organization WHERE id_root_org_unit IS NOT NULL);
</pre>

</div>

<h1 class="sectionedit26" id="release_09">Release 0.9</h1>
<div class="level1">

<p>
From 0.8.1 to 0.9, the following changes have to be performed on the schema:
</p>
<pre class="code">
DROP TABLE report;

ALTER TABLE project_model ADD COLUMN status VARCHAR(20) DEFAULT &#039;READY&#039;;
UPDATE project_model SET status = &#039;READY&#039; WHERE status IS NULL;

ALTER TABLE org_unit_model ADD COLUMN status VARCHAR(20) DEFAULT &#039;READY&#039;;
UPDATE org_unit_model SET status = &#039;READY&#039; WHERE status IS NULL;

ALTER TABLE Indicator CHANGE ActivityId ActivityId int(11) NULL;
ALTER TABLE Indicator CHANGE Units Units varchar(15) NULL;

ALTER TABLE locationtype CHANGE LocationTypeId LocationTypeId int(11) NOT NULL AUTO_INCREMENT; 

ALTER TABLE Site CHANGE ActivityId ActivityId int(11) NULL;</pre>

</div>

<h1 class="sectionedit27" id="revision_r1215_httpscodegooglecom_p_sigma-h_source_detail_r_1215">Revision [r1215](https://code.google.com/p/sigma-h/source/detail?r=1215)</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> Global export(export logger), Global export content (CSV content of export) and Global export settings (export settings per organization)</div>
</li>
</ul>

<p>
<code>
CREATE TABLE global_export
(
  id bigint NOT NULL,
  generated_date timestamp without time zone,
  organization_id integer NOT NULL,
  CONSTRAINT global_export_pkey PRIMARY KEY (id ),
  CONSTRAINT fk9e763fd0f85c2c3c FOREIGN KEY (organization_id)
      REFERENCES organization (id_organization) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE global_export_content
(
  id bigint NOT NULL,
  csv_content text,
  project_model_name character varying(8192) NOT NULL,
  global_export_id bigint NOT NULL,
  CONSTRAINT global_export_content_pkey PRIMARY KEY (id ),
  CONSTRAINT fkdca84b0af33647b9 FOREIGN KEY (global_export_id)
      REFERENCES global_export (id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE TABLE global_export_settings
(
  id bigint NOT NULL,
  auto_delete_frequency integer,
  auto_export_frequency integer,
  default_organization_export_format character varying(255),
  export_format character varying(255),
  last_export_date timestamp without time zone,
  locale_string character varying(4) NOT NULL,
  organization_id integer NOT NULL,
  CONSTRAINT global_export_settings_pkey PRIMARY KEY (id ),
  CONSTRAINT fk2fb477b2f85c2c3c FOREIGN KEY (organization_id)
      REFERENCES organization (id_organization) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
);

</code>
</p>
<ul>
<li class="level1"><div class="li"> Default global export settings</div>
</li>
</ul>
<pre class="code">
INSERT INTO global_export_settings (id, default_organization_export_format, auto_export_frequency, locale_string, organization_id) 
SELECT nextval(&#039;hibernate_sequence&#039;),&#039;ODS&#039;,1,&#039;fr&#039;, o.id_organization from organization o limit 1;</pre>
<blockquote><div class="no">
two added export related flags<pre class="code">
update flexible_element set exportable =true;
update flexible_element set globally_exportable =false;</pre>
<ul>
<li class="level1"><div class="li">Adds default GLOBAL_EXPORT permission to default “PioneerAdministrator” profile</div>
</li>
</ul>
<pre class="code">
INSERT INTO global_permission (id_global_permission, permission, id_profile) SELECT nextval(&#039;hibernate_sequence&#039;), &#039;GLOBAL_EXPORT&#039;, id_profile FROM profile WHERE name = &#039;PioneerAdministrator&#039; AND id_organization = (SELECT MAX(id_organization) FROM organization WHERE logo = &#039;logo&#039;);</pre>
</div></blockquote>

</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>contributorguide/schemachangelog.txt</bdi> · Last modified: 2017/12/19 12:40 by <bdi>osarrat</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="doku0b25.html?id=contributorguide:schemachangelog&amp;do=edit"  class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="doku07c8.html?id=contributorguide:schemachangelog&amp;do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="doku972b.html?id=contributorguide:schemachangelog&amp;do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" class="urlextern">CC Attribution-Share Alike 4.0 International</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license"><img src="lib/images/license/button/cc-by-sa.png" alt="CC Attribution-Share Alike 4.0 International" /></a>        <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="lib/tpl/dokuwiki/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://php.net/" title="Powered by PHP" ><img
            src="lib/tpl/dokuwiki/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="lib/tpl/dokuwiki/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="lib/tpl/dokuwiki/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="lib/tpl/dokuwiki/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="lib/exe/indexer0e53.gif?id=contributorguide%3Aschemachangelog&amp;1530808558" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div></body>

<!-- Mirrored from wiki.sigmah.org/doku.php?id=contributorguide:schemachangelog by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Jul 2018 16:39:28 GMT -->
</html>
